// 测试宏：综合测试用例
// 覆盖多个宏定义、不同类型返回值、各种使用场景

// ========== 数学常量宏 ==========
mc PI_INT() expr {
    @mc_code(@mc_ast(3));
}

mc E_INT() expr {
    @mc_code(@mc_ast(2));
}

mc GOLDEN_RATIO() expr {
    @mc_code(@mc_ast(1));
}

// ========== 配置常量宏 ==========
mc MAX_BUFFER_SIZE() expr {
    @mc_code(@mc_ast(1024));
}

mc MIN_BUFFER_SIZE() expr {
    @mc_code(@mc_ast(64));
}

mc DEFAULT_TIMEOUT() expr {
    @mc_code(@mc_ast(5000));
}

// ========== 位操作常量宏 ==========
mc FLAG_READ() expr {
    @mc_code(@mc_ast(1));
}

mc FLAG_WRITE() expr {
    @mc_code(@mc_ast(2));
}

mc FLAG_EXECUTE() expr {
    @mc_code(@mc_ast(4));
}

mc FLAG_ALL() expr {
    @mc_code(@mc_ast(7));
}

// ========== 状态码宏 ==========
mc STATUS_OK() expr {
    @mc_code(@mc_ast(0));
}

mc STATUS_ERR() expr {
    @mc_code(@mc_ast(-1));
}

mc STATUS_PENDING() expr {
    @mc_code(@mc_ast(1));
}

// ========== 布尔常量宏 ==========
mc FEATURE_ENABLED() expr {
    @mc_code(@mc_ast(true));
}

mc DEBUG_MODE() expr {
    @mc_code(@mc_ast(false));
}

// ========== 测试函数 ==========

fn test_math_constants() i32 {
    const pi: i32 = PI_INT();
    const e: i32 = E_INT();
    const golden: i32 = GOLDEN_RATIO();
    
    if pi != 3 { return 1; }
    if e != 2 { return 2; }
    if golden != 1 { return 3; }
    
    // 测试组合使用
    const sum: i32 = pi + e + golden;
    if sum != 6 { return 4; }
    
    return 0;
}

fn test_config_constants() i32 {
    const max_size: i32 = MAX_BUFFER_SIZE();
    const min_size: i32 = MIN_BUFFER_SIZE();
    const timeout: i32 = DEFAULT_TIMEOUT();
    
    if max_size != 1024 { return 1; }
    if min_size != 64 { return 2; }
    if timeout != 5000 { return 3; }
    
    // 测试比较
    if max_size <= min_size { return 4; }
    if timeout < max_size { return 5; }
    
    return 0;
}

fn test_bit_flags() i32 {
    const read: i32 = FLAG_READ();
    const write: i32 = FLAG_WRITE();
    const execute: i32 = FLAG_EXECUTE();
    const all: i32 = FLAG_ALL();
    
    if read != 1 { return 1; }
    if write != 2 { return 2; }
    if execute != 4 { return 3; }
    if all != 7 { return 4; }
    
    // 测试位运算
    const combined: i32 = read | write | execute;
    if combined != all { return 5; }
    
    if (all & read) != read { return 6; }
    if (all & write) != write { return 7; }
    if (all & execute) != execute { return 8; }
    
    return 0;
}

fn test_status_codes() i32 {
    const ok: i32 = STATUS_OK();
    const err_code: i32 = STATUS_ERR();
    const pending: i32 = STATUS_PENDING();
    
    if ok != 0 { return 1; }
    if err_code != -1 { return 2; }
    if pending != 1 { return 3; }
    
    // 测试条件判断
    if ok != STATUS_OK() { return 4; }
    if err_code >= STATUS_OK() { return 5; }
    
    return 0;
}

fn test_boolean_constants() i32 {
    const enabled: bool = FEATURE_ENABLED();
    const debug: bool = DEBUG_MODE();
    
    if !enabled { return 1; }
    if debug { return 2; }
    
    // 测试逻辑运算
    if !(enabled && !debug) { return 3; }
    if !enabled || debug { return 4; }
    
    return 0;
}

fn test_complex_scenario() i32 {
    // 模拟真实使用场景：配置驱动的逻辑
    
    var buffer_size: i32 = MIN_BUFFER_SIZE();
    
    if FEATURE_ENABLED() {
        buffer_size = MAX_BUFFER_SIZE();
    }
    
    if buffer_size != 1024 { return 1; }
    
    // 模拟权限检查
    var permissions: i32 = 0;
    
    if !DEBUG_MODE() {
        permissions = FLAG_READ() | FLAG_WRITE();
    } else {
        permissions = FLAG_ALL();
    }
    
    if permissions != 3 { return 2; }  // read | write = 3
    
    // 模拟状态机
    var status: i32 = STATUS_PENDING();
    
    if status == STATUS_PENDING() {
        status = STATUS_OK();
    }
    
    if status != STATUS_OK() { return 3; }
    
    return 0;
}

fn test_macro_in_expressions() i32 {
    // 测试宏在各种表达式中的使用
    
    // 三元形式（使用 if-else）
    const val: i32 = 10;
    var result: i32 = 0;
    if val > PI_INT() {
        result = STATUS_OK();
    } else {
        result = STATUS_ERR();
    }
    if result != 0 { return 1; }
    
    // 复杂算术
    const calc: i32 = (MAX_BUFFER_SIZE() - MIN_BUFFER_SIZE()) / PI_INT();
    if calc != 320 { return 2; }  // (1024 - 64) / 3 = 320
    
    // 位运算链
    const flags: i32 = (FLAG_READ() << 8) | FLAG_WRITE();
    if flags != 258 { return 3; }  // (1 << 8) | 2 = 256 | 2 = 258
    
    return 0;
}

fn main() i32 {
    var result: i32 = 0;
    
    result = test_math_constants();
    if result != 0 { return result + 100; }
    
    result = test_config_constants();
    if result != 0 { return result + 200; }
    
    result = test_bit_flags();
    if result != 0 { return result + 300; }
    
    result = test_status_codes();
    if result != 0 { return result + 400; }
    
    result = test_boolean_constants();
    if result != 0 { return result + 500; }
    
    result = test_complex_scenario();
    if result != 0 { return result + 600; }
    
    result = test_macro_in_expressions();
    if result != 0 { return result + 700; }
    
    return 0;
}

