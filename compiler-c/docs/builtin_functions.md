# Uya å†…ç½®å‡½æ•°ä½¿ç”¨æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv0.1.0ï¼ˆ2026-02-06ï¼‰  
> æ‰€æœ‰å†…ç½®å‡½æ•°å‡ä»¥ `@` å¼€å¤´ï¼Œç¼–è¯‘æœŸå±•å¼€ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€ï¼Œæ— éœ€å¯¼å…¥æˆ–å£°æ˜

---

## ç›®å½•

- [1. ç±»å‹åå°„å‡½æ•°](#1-ç±»å‹åå°„å‡½æ•°)
  - [@size_of](#size_of)
  - [@align_of](#align_of)
  - [@len](#len)
- [2. æ•´æ•°æå€¼å‡½æ•°](#2-æ•´æ•°æå€¼å‡½æ•°)
  - [@max](#max)
  - [@min](#min)
- [3. æºä»£ç ä½ç½®å‡½æ•°](#3-æºä»£ç ä½ç½®å‡½æ•°)
  - [@src_name](#src_name)
  - [@src_path](#src_path)
  - [@src_line](#src_line)
  - [@src_col](#src_col)
  - [@func_name](#func_name)
- [4. å¯å˜å‚æ•°å‡½æ•°](#4-å¯å˜å‚æ•°å‡½æ•°)
  - [@params](#params)
- [5. å®ç¼–è¯‘æ—¶å‡½æ•°](#5-å®ç¼–è¯‘æ—¶å‡½æ•°)
  - [@mc_eval](#mc_eval)
  - [@mc_type](#mc_type)
  - [@mc_ast](#mc_ast)
  - [@mc_code](#mc_code)
  - [@mc_error](#mc_error)
  - [@mc_get_env](#mc_get_env)
- [6. å¼‚æ­¥ç¼–ç¨‹å‡½æ•°](#6-å¼‚æ­¥ç¼–ç¨‹å‡½æ•°)
  - [@async_fn](#async_fn)
  - [@await](#await)

---

## 1. ç±»å‹åå°„å‡½æ•°

### @size_of

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @size_of(Type) i32
fn @size_of(expr) i32
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›ç±»å‹çš„å­—èŠ‚å¤§å°ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰ã€‚æ”¯æŒä¼ å…¥ç±»å‹åæˆ–è¡¨è¾¾å¼ã€‚

**å‚æ•°**ï¼š
- `Type`ï¼šä»»æ„ç±»å‹åï¼ˆåŸºç¡€ç±»å‹ã€æ•°ç»„ã€ç»“æ„ä½“ã€åˆ‡ç‰‡ç­‰ï¼‰
- `expr`ï¼šä»»æ„è¡¨è¾¾å¼ï¼ˆä»è¡¨è¾¾å¼æ¨æ–­ç±»å‹ï¼‰

**è¿”å›å€¼**ï¼š
- `i32` ç±»å‹ï¼Œè¡¨ç¤ºç±»å‹çš„å­—èŠ‚å¤§å°
- ç¼–è¯‘æœŸå¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// åŸºç¡€ç±»å‹
const size_i32: i32 = @size_of(i32);        // 4
const size_i64: i32 = @size_of(i64);        // 8
const size_f32: i32 = @size_of(f32);        // 4
const size_bool: i32 = @size_of(bool);      // 1

// æ•°ç»„ç±»å‹
const size_arr: i32 = @size_of([i32: 10]);  // 40 (10 * 4)

// ç»“æ„ä½“ç±»å‹
struct Point {
    x: i32,
    y: i32
}
const size_point: i32 = @size_of(Point);    // 8 (4 + 4)

// åˆ‡ç‰‡ç±»å‹
const size_slice: i32 = @size_of(&[i32]);   // 8/16ï¼ˆ32ä½/64ä½å¹³å°ï¼‰

// è¡¨è¾¾å¼
var x: i32 = 10;
const size_x: i32 = @size_of(x);            // 4

// æŒ‡é’ˆç±»å‹
const size_ptr: i32 = @size_of(&i32);       // 4/8ï¼ˆ32ä½/64ä½å¹³å°ï¼‰
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¯¹é½è§„åˆ™ä¸ C99 ä¸€è‡´
- ç»“æ„ä½“å¤§å°åŒ…å«å¡«å……å­—èŠ‚
- åˆ‡ç‰‡ç±»å‹å¤§å° = æŒ‡é’ˆå¤§å° + é•¿åº¦å­—æ®µå¤§å°ï¼ˆå¹³å°ç›¸å…³ï¼‰

---

### @align_of

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @align_of(Type) i32
fn @align_of(expr) i32
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›ç±»å‹çš„å¯¹é½å­—èŠ‚æ•°ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰ã€‚

**å‚æ•°**ï¼š
- `Type`ï¼šä»»æ„ç±»å‹å
- `expr`ï¼šä»»æ„è¡¨è¾¾å¼ï¼ˆä»è¡¨è¾¾å¼æ¨æ–­ç±»å‹ï¼‰

**è¿”å›å€¼**ï¼š
- `i32` ç±»å‹ï¼Œè¡¨ç¤ºç±»å‹çš„å¯¹é½å­—èŠ‚æ•°
- ç¼–è¯‘æœŸå¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// åŸºç¡€ç±»å‹
const align_i8: i32 = @align_of(i8);        // 1
const align_i16: i32 = @align_of(i16);      // 2
const align_i32: i32 = @align_of(i32);      // 4
const align_i64: i32 = @align_of(i64);      // 8
const align_f64: i32 = @align_of(f64);      // 8

// ç»“æ„ä½“ç±»å‹
struct Mixed {
    a: i8,      // å¯¹é½ 1
    b: i32,     // å¯¹é½ 4
    c: i16      // å¯¹é½ 2
}
const align_mixed: i32 = @align_of(Mixed);  // 4ï¼ˆå–æœ€å¤§å¯¹é½ï¼‰

// æ•°ç»„ç±»å‹ï¼ˆä¸å…ƒç´ ç±»å‹å¯¹é½ç›¸åŒï¼‰
const align_arr: i32 = @align_of([i32: 10]); // 4

// æŒ‡é’ˆç±»å‹
const align_ptr: i32 = @align_of(&i32);     // 4/8ï¼ˆå¹³å°ç›¸å…³ï¼‰
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¯¹é½è§„åˆ™ä¸ C99 ä¸€è‡´
- ç»“æ„ä½“å¯¹é½ = max(æ‰€æœ‰å­—æ®µå¯¹é½)
- æ•°ç»„å¯¹é½ = å…ƒç´ ç±»å‹å¯¹é½

---

### @len

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @len(array: [T: N]) i32
fn @len(slice: &[T]) i32
fn @len(slice: &[T: N]) i32
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›æ•°ç»„æˆ–åˆ‡ç‰‡çš„å…ƒç´ ä¸ªæ•°ã€‚å¯¹äºæ•°ç»„æ˜¯ç¼–è¯‘æœŸå¸¸é‡ï¼Œå¯¹äºåˆ‡ç‰‡æ˜¯è¿è¡Œæ—¶å€¼ã€‚

**å‚æ•°**ï¼š
- `array`ï¼šå›ºå®šå¤§å°æ•°ç»„
- `slice`ï¼šåˆ‡ç‰‡å¼•ç”¨

**è¿”å›å€¼**ï¼š
- `i32` ç±»å‹
- å¯¹äºæ•°ç»„ï¼šç¼–è¯‘æœŸå¸¸é‡ `N`
- å¯¹äºåˆ‡ç‰‡ï¼šè¿è¡Œæ—¶å€¼ï¼ˆè®¿é—®åˆ‡ç‰‡çš„ `.len` å­—æ®µï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// å›ºå®šæ•°ç»„ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰
var arr: [i32: 10] = [];
const len1: i32 = @len(arr);                // 10

// ç©ºæ•°ç»„å­—é¢é‡ï¼ˆä»å£°æ˜è·å–å¤§å°ï¼‰
var buffer: [i32: 100] = [];
const len2: i32 = @len(buffer);             // 100ï¼ˆä¸æ˜¯ 0ï¼ï¼‰

// å¤šç»´æ•°ç»„
var matrix: [[i32: 5]: 3] = [];
const rows: i32 = @len(matrix);             // 3
const cols: i32 = @len(matrix[0]);          // 5

// åˆ‡ç‰‡ï¼ˆè¿è¡Œæ—¶å€¼ï¼‰
fn process(data: &[i32]) void {
    const count: i32 = @len(data);          // è¿è¡Œæ—¶è®¿é—® data.len
    // ...
}

// å·²çŸ¥é•¿åº¦çš„åˆ‡ç‰‡
fn process_fixed(data: &[i32: 10]) void {
    const count: i32 = @len(data);          // 10ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- **ç©ºæ•°ç»„å­—é¢é‡**ï¼š`var x: [T: N] = [];` æ—¶ï¼Œ`@len(x)` è¿”å› `N`ï¼Œä¸æ˜¯ 0
- å¯¹äºåˆ‡ç‰‡ï¼Œç­‰ä»·äºè®¿é—® `.len` å­—æ®µ
- å¯¹äºæ•°ç»„ï¼Œåœ¨ç¼–è¯‘æœŸæ±‚å€¼ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

---

## 2. æ•´æ•°æå€¼å‡½æ•°

### @max

**å‡½æ•°ç­¾å**ï¼š
```uya
@max  // ç±»å‹ä»ä¸Šä¸‹æ–‡æ¨æ–­
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›æ•´æ•°ç±»å‹çš„æœ€å¤§å€¼ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰ã€‚ç±»å‹ä»èµ‹å€¼ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°ï¼Œç±»å‹é€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­

**è¿”å›å€¼**ï¼š
- æ¨æ–­å‡ºçš„æ•´æ•°ç±»å‹
- ç¼–è¯‘æœŸå¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// æœ‰ç¬¦å·æ•´æ•°
const max_i8: i8 = @max;        // 127
const max_i16: i16 = @max;      // 32767
const max_i32: i32 = @max;      // 2147483647
const max_i64: i64 = @max;      // 9223372036854775807

// æ— ç¬¦å·æ•´æ•°
const max_u8: u8 = @max;        // 255
const max_u16: u16 = @max;      // 65535
const max_u32: u32 = @max;      // 4294967295
const max_u64: u64 = @max;      // 18446744073709551615

// åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨
fn clamp(value: i32, min_val: i32, max_val: i32) i32 {
    if value < min_val {
        return min_val;
    }
    if value > max_val {
        return max_val;
    }
    return value;
}

// è¾¹ç•Œæ£€æŸ¥
fn safe_add(a: i32, b: i32) !i32 {
    if b > 0 && a > (@max - b) {
        return error.Overflow;
    }
    return a + b;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»æœ‰æ˜ç¡®çš„ç±»å‹ä¸Šä¸‹æ–‡ï¼ˆå˜é‡å£°æ˜ã€å‡½æ•°å‚æ•°ç­‰ï¼‰
- ä»…æ”¯æŒæ•´æ•°ç±»å‹ï¼ˆi8, i16, i32, i64, u8, u16, u32, u64ï¼‰
- å¦‚æœç±»å‹æ— æ³•æ¨æ–­ï¼Œä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯

---

### @min

**å‡½æ•°ç­¾å**ï¼š
```uya
@min  // ç±»å‹ä»ä¸Šä¸‹æ–‡æ¨æ–­
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›æ•´æ•°ç±»å‹çš„æœ€å°å€¼ï¼ˆç¼–è¯‘æœŸå¸¸é‡ï¼‰ã€‚ç±»å‹ä»èµ‹å€¼ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨æ–­ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°ï¼Œç±»å‹é€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­

**è¿”å›å€¼**ï¼š
- æ¨æ–­å‡ºçš„æ•´æ•°ç±»å‹
- ç¼–è¯‘æœŸå¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// æœ‰ç¬¦å·æ•´æ•°
const min_i8: i8 = @min;        // -128
const min_i16: i16 = @min;      // -32768
const min_i32: i32 = @min;      // -2147483648
const min_i64: i64 = @min;      // -9223372036854775808

// æ— ç¬¦å·æ•´æ•°
const min_u8: u8 = @min;        // 0
const min_u16: u16 = @min;      // 0
const min_u32: u32 = @min;      // 0
const min_u64: u64 = @min;      // 0

// åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨
fn abs(value: i32) i32 {
    if value == @min {
        // ç‰¹æ®Šå¤„ç†ï¼ši32 æœ€å°å€¼çš„ç»å¯¹å€¼æ— æ³•è¡¨ç¤ºä¸º i32
        return @max;
    }
    if value < 0 {
        return -value;
    }
    return value;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»æœ‰æ˜ç¡®çš„ç±»å‹ä¸Šä¸‹æ–‡
- ä»…æ”¯æŒæ•´æ•°ç±»å‹
- æ— ç¬¦å·ç±»å‹çš„ `@min` æ€»æ˜¯ 0

---

## 3. æºä»£ç ä½ç½®å‡½æ•°

### @src_name

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @src_name() &[i8]
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›å½“å‰æºæ–‡ä»¶çš„æ–‡ä»¶åï¼ˆä¸åŒ…å«è·¯å¾„ï¼‰ï¼Œç¼–è¯‘æœŸå±•å¼€ä¸ºå­—ç¬¦ä¸²å¸¸é‡ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°

**è¿”å›å€¼**ï¼š
- `&[i8]` ç±»å‹ï¼ˆå­—èŠ‚åˆ‡ç‰‡ï¼‰
- ç¼–è¯‘æœŸå­—ç¬¦ä¸²å¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
extern printf(fmt: *byte, ...) i32;

fn debug_info() void {
    const filename: &[i8] = @src_name;
    printf("File: %s\n" as *byte, filename);
}

fn main() i32 {
    debug_info();  // è¾“å‡ºï¼šFile: main.uya
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ä»…åŒ…å«æ–‡ä»¶åï¼Œä¸åŒ…å«è·¯å¾„
- ç¼–è¯‘æœŸå±•å¼€ä¸ºå­—ç¬¦ä¸²å¸¸é‡
- å­—ç¬¦ä¸²å¸¸é‡è‡ªåŠ¨æ”¶é›†å¹¶ç”Ÿæˆåˆ°è¾“å‡ºæ–‡ä»¶ä¸­

---

### @src_path

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @src_path() &[i8]
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›å½“å‰æºæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œç¼–è¯‘æœŸå±•å¼€ä¸ºå­—ç¬¦ä¸²å¸¸é‡ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°

**è¿”å›å€¼**ï¼š
- `&[i8]` ç±»å‹ï¼ˆå­—èŠ‚åˆ‡ç‰‡ï¼‰
- ç¼–è¯‘æœŸå­—ç¬¦ä¸²å¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
extern printf(fmt: *byte, ...) i32;

fn log_location() void {
    const path: &[i8] = @src_path;
    const line: i32 = @src_line;
    printf("Location: %s:%d\n" as *byte, path, line);
}

fn main() i32 {
    log_location();  // è¾“å‡ºï¼šLocation: /path/to/main.uya:10
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- åŒ…å«å®Œæ•´çš„æ–‡ä»¶è·¯å¾„ï¼ˆç¼–è¯‘æ—¶çš„è·¯å¾„ï¼‰
- è·¯å¾„æ ¼å¼å–å†³äºç¼–è¯‘ç¯å¢ƒï¼ˆUnix: `/`, Windows: `\`ï¼‰

---

### @src_line

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @src_line() i32
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›å½“å‰ä»£ç æ‰€åœ¨çš„è¡Œå·ï¼Œç¼–è¯‘æœŸå±•å¼€ä¸ºæ•´æ•°å¸¸é‡ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°

**è¿”å›å€¼**ï¼š
- `i32` ç±»å‹
- ç¼–è¯‘æœŸæ•´æ•°å¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
extern printf(fmt: *byte, ...) i32;

fn assert_impl(condition: bool, msg: *byte, line: i32) void {
    if !condition {
        printf("Assertion failed at line %d: %s\n" as *byte, line, msg);
        // è§¦å‘æ–­è¨€å¤±è´¥å¤„ç†
    }
}

// è‡ªå®šä¹‰æ–­è¨€å®ï¼ˆä¼ªä»£ç ï¼Œå®é™…éœ€è¦å®ç³»ç»Ÿï¼‰
fn main() i32 {
    const x: i32 = 10;
    
    // æ‰‹åŠ¨ä¼ é€’è¡Œå·
    if !(x > 0) {
        assert_impl(false, "x must be positive" as *byte, @src_line);
    }
    
    printf("Current line: %d\n" as *byte, @src_line);  // è¾“å‡ºå½“å‰è¡Œå·
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- è¡Œå·ä» 1 å¼€å§‹
- æ¯æ¬¡è°ƒç”¨ `@src_line` éƒ½ä¼šå±•å¼€ä¸ºè°ƒç”¨å¤„çš„è¡Œå·

---

### @src_col

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @src_col() i32
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›å½“å‰ä»£ç æ‰€åœ¨çš„åˆ—å·ï¼Œç¼–è¯‘æœŸå±•å¼€ä¸ºæ•´æ•°å¸¸é‡ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°

**è¿”å›å€¼**ï¼š
- `i32` ç±»å‹
- ç¼–è¯‘æœŸæ•´æ•°å¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
extern printf(fmt: *byte, ...) i32;

fn main() i32 {
    const line: i32 = @src_line;
    const col: i32 = @src_col;
    
    printf("Position: line %d, column %d\n" as *byte, line, col);
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- åˆ—å·ä» 1 å¼€å§‹
- æŒ‡å‘ `@src_col` æ ‡è®°çš„èµ·å§‹ä½ç½®

---

### @func_name

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @func_name() &[i8]
```

**åŠŸèƒ½æè¿°**ï¼š
è¿”å›å½“å‰å‡½æ•°çš„åç§°ï¼Œç¼–è¯‘æœŸå±•å¼€ä¸ºå­—ç¬¦ä¸²å¸¸é‡ã€‚ä»…èƒ½åœ¨å‡½æ•°ä½“å†…ä½¿ç”¨ã€‚

**å‚æ•°**ï¼š
- æ— å‚æ•°

**è¿”å›å€¼**ï¼š
- `&[i8]` ç±»å‹ï¼ˆå­—èŠ‚åˆ‡ç‰‡ï¼‰
- ç¼–è¯‘æœŸå­—ç¬¦ä¸²å¸¸é‡ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
extern printf(fmt: *byte, ...) i32;

fn trace_enter() void {
    const func: &[i8] = @func_name;
    const line: i32 = @src_line;
    printf("Entering %s at line %d\n" as *byte, func, line);
}

fn process_data(data: &[i32]) void {
    const func: &[i8] = @func_name;
    printf("Function: %s\n" as *byte, func);  // è¾“å‡ºï¼šFunction: process_data
    // ...
}

fn main() i32 {
    const func: &[i8] = @func_name;
    printf("Main function: %s\n" as *byte, func);  // è¾“å‡ºï¼šMain function: main
    
    trace_enter();     // è¾“å‡ºï¼šEntering trace_enter at line ...
    process_data(null);
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- **ä»…èƒ½åœ¨å‡½æ•°ä½“å†…ä½¿ç”¨**ï¼Œåœ¨å‡½æ•°å¤–ä½¿ç”¨ä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯
- è¿”å›çš„æ˜¯å‡½æ•°çš„åŸå§‹åç§°ï¼ˆä¸åŒ…å«ä¿®é¥°ç¬¦ï¼‰
- å¯¹äº `main` å‡½æ•°ï¼Œè¿”å› `"main"`

**é”™è¯¯ç¤ºä¾‹**ï¼š
```uya
// ç¼–è¯‘é”™è¯¯ï¼š@func_name åªèƒ½åœ¨å‡½æ•°ä½“å†…ä½¿ç”¨
const global_func: &[i8] = @func_name;  // âŒ é”™è¯¯ï¼

fn valid_usage() void {
    const local_func: &[i8] = @func_name;  // âœ“ æ­£ç¡®
}
```

---

## 4. å¯å˜å‚æ•°å‡½æ•°

### @params

**å‡½æ•°ç­¾å**ï¼š
```uya
@params  // åœ¨å¯å˜å‚æ•°å‡½æ•°å†…éƒ¨ä½¿ç”¨
```

**åŠŸèƒ½æè¿°**ï¼š
åœ¨å¯å˜å‚æ•°å‡½æ•°å†…éƒ¨è®¿é—®å¯å˜å‚æ•°åˆ—è¡¨ã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å†…ç½®æ ‡è¯†ç¬¦ï¼Œè¡¨ç¤º `va_list` ç±»å‹çš„å‚æ•°ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨äºå®ç°ç±»ä¼¼ `printf` çš„å¯å˜å‚æ•°å‡½æ•°
- ä¸ FFI çš„ `va_start`ã€`va_arg`ã€`va_end` é…åˆä½¿ç”¨

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// å¤–éƒ¨ C å‡½æ•°å£°æ˜
extern va_start(ap: &void, last_param: &void) void;
extern va_arg(ap: &void, type_size: i32) i32;
extern va_end(ap: &void) void;
extern printf(fmt: *byte, ...) i32;

// Uya å¯å˜å‚æ•°å‡½æ•°
fn my_printf(fmt: *byte, ...) void {
    // @params ä»£è¡¨å¯å˜å‚æ•°åˆ—è¡¨
    var ap: &void = @params;
    
    // ä½¿ç”¨ C çš„ va_* å‡½æ•°å¤„ç†
    printf(fmt, ap);
}

fn sum_ints(count: i32, ...) i32 {
    var result: i32 = 0;
    var ap: &void = @params;
    
    var i: i32 = 0;
    while i < count {
        const value: i32 = va_arg(ap, @size_of(i32));
        result = result + value;
        i = i + 1;
    }
    
    return result;
}

fn main() i32 {
    my_printf("Hello, %s!\n" as *byte, "World" as *byte);
    
    const total: i32 = sum_ints(3, 10, 20, 30);
    printf("Total: %d\n" as *byte, total);  // è¾“å‡ºï¼šTotal: 60
    
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ä»…åœ¨å£°æ˜ä¸º `...` çš„å¯å˜å‚æ•°å‡½æ•°å†…æœ‰æ•ˆ
- éœ€è¦é…åˆ C çš„ `va_*` å‡½æ•°ä½¿ç”¨
- ç±»å‹å®‰å…¨éœ€è¦æ‰‹åŠ¨ä¿è¯ï¼ˆä¸ C å¯å˜å‚æ•°ç›¸åŒï¼‰

---

## 5. å®ç¼–è¯‘æ—¶å‡½æ•°

> **çŠ¶æ€**ï¼šè¯­æ³•è§£æå·²å®ç°ï¼ŒCPS å˜æ¢å’Œæ±‚å€¼å¼•æ“å¾…å®ç°  
> **å‚è€ƒ**ï¼šè§„èŒƒ Â§25 å®ç³»ç»Ÿ

### @mc_eval

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_eval(expr) T  // ç¼–è¯‘æ—¶æ±‚å€¼
```

**åŠŸèƒ½æè¿°**ï¼š
åœ¨ç¼–è¯‘æ—¶å¯¹è¡¨è¾¾å¼æ±‚å€¼ï¼Œè¿”å›æ±‚å€¼ç»“æœã€‚ä»…èƒ½åœ¨å®å®šä¹‰ (`mc`) å†…éƒ¨ä½¿ç”¨ã€‚

**å‚æ•°**ï¼š
- `expr`ï¼šä»»æ„ç¼–è¯‘æœŸå¯æ±‚å€¼çš„è¡¨è¾¾å¼

**è¿”å›å€¼**ï¼š
- è¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœ
- ç±»å‹ç”±è¡¨è¾¾å¼å†³å®š

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
// ç¼–è¯‘æ—¶è®¡ç®—æ–æ³¢é‚£å¥‘æ•°
mc fib(n: i32) i32 {
    if n <= 1 {
        return n;
    }
    const a: i32 = @mc_eval(fib(n - 1));
    const b: i32 = @mc_eval(fib(n - 2));
    return a + b;
}

fn main() i32 {
    const fib10: i32 = fib(10);  // ç¼–è¯‘æ—¶è®¡ç®—ï¼Œç»“æœ 55
    return fib10;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ä»…åœ¨å®å®šä¹‰å†…ä½¿ç”¨
- è¡¨è¾¾å¼å¿…é¡»åœ¨ç¼–è¯‘æœŸå¯æ±‚å€¼
- é€’å½’æ±‚å€¼å—ç¼–è¯‘å™¨é€’å½’æ·±åº¦é™åˆ¶

---

### @mc_type

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_type(expr) TypeInfo
```

**åŠŸèƒ½æè¿°**ï¼š
åœ¨ç¼–è¯‘æ—¶è·å–è¡¨è¾¾å¼çš„ç±»å‹ä¿¡æ¯ï¼Œè¿”å› `TypeInfo` ç»“æ„ä½“ã€‚

**è¿”å›å€¼**ï¼š
```uya
struct TypeInfo {
    kind: TypeKind,      // ç±»å‹ç§ç±»ï¼ˆi32, struct, etc.ï¼‰
    name: *byte,         // ç±»å‹åç§°
    size: i32,           // ç±»å‹å¤§å°
    align: i32,          // ç±»å‹å¯¹é½
    // ... å…¶ä»–å­—æ®µ
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
mc print_type_info(expr) void {
    const info: TypeInfo = @mc_type(expr);
    @mc_eval(printf("Type: %s, Size: %d, Align: %d\n" as *byte, 
                     info.name, info.size, info.align));
}

fn main() i32 {
    var x: i32 = 10;
    print_type_info(x);  // è¾“å‡ºï¼šType: i32, Size: 4, Align: 4
    return 0;
}
```

---

### @mc_ast

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_ast(code) ASTNode
```

**åŠŸèƒ½æè¿°**ï¼š
å°†ä»£ç ç‰‡æ®µè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
mc generate_getter(field_name) code {
    const ast: ASTNode = @mc_ast({
        fn get_field() i32 {
            return self.field_name;
        }
    });
    return @mc_code(ast);
}
```

---

### @mc_code

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_code(ast: ASTNode) code
```

**åŠŸèƒ½æè¿°**ï¼š
å°†æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢ä¸ºä»£ç ã€‚

---

### @mc_error

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_error(msg: *byte) void
```

**åŠŸèƒ½æè¿°**ï¼š
åœ¨ç¼–è¯‘æ—¶æŠ¥å‘Šé”™è¯¯ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
mc check_positive(n: i32) void {
    if n <= 0 {
        @mc_error("Value must be positive");
    }
}
```

---

### @mc_get_env

**å‡½æ•°ç­¾å**ï¼š
```uya
fn @mc_get_env(key: *byte) *byte
```

**åŠŸèƒ½æè¿°**ï¼š
åœ¨ç¼–è¯‘æ—¶è·å–ç¯å¢ƒå˜é‡ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
mc get_build_env() *byte {
    return @mc_get_env("BUILD_ENV");
}
```

---

## 6. å¼‚æ­¥ç¼–ç¨‹å‡½æ•°

> **çŠ¶æ€**ï¼šè¯­æ³•è§£æå·²å®ç°ï¼ŒCPS å˜æ¢å’ŒçŠ¶æ€æœºç”Ÿæˆå¾…å®ç°  
> **å‚è€ƒ**ï¼šè§„èŒƒ Â§18 å¼‚æ­¥ç¼–ç¨‹

### @async_fn

**å‡½æ•°ç­¾å**ï¼š
```uya
@async_fn fn function_name(...) !Future<T>
```

**åŠŸèƒ½æè¿°**ï¼š
æ ‡è®°å‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œè§¦å‘ç¼–è¯‘å™¨è¿›è¡Œ CPS å˜æ¢ï¼Œç”Ÿæˆæ˜¾å¼çŠ¶æ€æœºã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
@async_fn fn fetch_data(url: *byte) !Future<i32> {
    const conn: Connection = try @await connect(url);
    const data: i32 = try @await read_data(conn);
    return data;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»è¿”å› `!Future<T>` ç±»å‹
- å‡½æ•°ä½“å†…å¯ä»¥ä½¿ç”¨ `@await`
- ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”ŸæˆçŠ¶æ€æœºä»£ç 

---

### @await

**å‡½æ•°ç­¾å**ï¼š
```uya
try @await future_expr
```

**åŠŸèƒ½æè¿°**ï¼š
å”¯ä¸€çš„æ˜¾å¼æŒ‚èµ·ç‚¹ï¼Œç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚ä»…èƒ½åœ¨ `@async_fn` å‡½æ•°å†…ä½¿ç”¨ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```uya
@async_fn fn process() !Future<void> {
    // ç­‰å¾…å¼‚æ­¥ I/O
    const data: &[byte] = try @await read_file("config.txt");
    
    // ç­‰å¾…å¼‚æ­¥è®¡ç®—
    const result: i32 = try @await compute_heavy_task(data);
    
    // ç­‰å¾…å¼‚æ­¥å†™å…¥
    try @await write_file("output.txt", result);
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»é…åˆ `try` ä½¿ç”¨ï¼ˆå¤„ç†é”™è¯¯ï¼‰
- ä»…åœ¨ `@async_fn` å‡½æ•°å†…æœ‰æ•ˆ
- æ¯ä¸ª `@await` æ˜¯ä¸€ä¸ªæŒ‚èµ·ç‚¹ï¼ŒçŠ¶æ€æœºä¼šåœ¨æ­¤å¤„ä¿å­˜/æ¢å¤

---

## 7. å†…ç½®å‡½æ•°åˆ†ç±»æ€»ç»“

| åˆ†ç±» | å‡½æ•° | ç¼–è¯‘æœŸ | è¿è¡Œæ—¶ | çŠ¶æ€ |
|------|------|--------|--------|------|
| **ç±»å‹åå°„** | `@size_of` | âœ“ | - | âœ… å·²å®ç° |
| | `@align_of` | âœ“ | - | âœ… å·²å®ç° |
| | `@len` (æ•°ç»„) | âœ“ | - | âœ… å·²å®ç° |
| | `@len` (åˆ‡ç‰‡) | - | âœ“ | âœ… å·²å®ç° |
| **æ•´æ•°æå€¼** | `@max` | âœ“ | - | âœ… å·²å®ç° |
| | `@min` | âœ“ | - | âœ… å·²å®ç° |
| **æºç ä½ç½®** | `@src_name` | âœ“ | - | âœ… å·²å®ç° |
| | `@src_path` | âœ“ | - | âœ… å·²å®ç° |
| | `@src_line` | âœ“ | - | âœ… å·²å®ç° |
| | `@src_col` | âœ“ | - | âœ… å·²å®ç° |
| | `@func_name` | âœ“ | - | âœ… å·²å®ç° |
| **å¯å˜å‚æ•°** | `@params` | - | âœ“ | âœ… å·²å®ç° |
| **å®ç³»ç»Ÿ** | `@mc_eval` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@mc_type` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@mc_ast` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@mc_code` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@mc_error` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@mc_get_env` | âœ“ | - | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| **å¼‚æ­¥ç¼–ç¨‹** | `@async_fn` | âœ“ | âœ“ | ğŸš§ è¯­æ³•è§£æå®Œæˆ |
| | `@await` | âœ“ | âœ“ | ğŸš§ è¯­æ³•è§£æå®Œæˆ |

---

## 8. å‘½åæƒ¯ä¾‹

Uya å†…ç½®å‡½æ•°éµå¾ªä»¥ä¸‹å‘½åæƒ¯ä¾‹ï¼š

1. **å•ä¸€æ¦‚å¿µ**ï¼šä½¿ç”¨çŸ­å½¢å¼
   - `@len`, `@max`, `@min`

2. **å¤åˆæ¦‚å¿µ**ï¼šä½¿ç”¨ snake_caseï¼ˆä¸‹åˆ’çº¿åˆ†éš”ï¼‰
   - `@size_of`, `@align_of`, `@async_fn`
   - `@src_name`, `@src_path`, `@src_line`, `@src_col`, `@func_name`
   - `@mc_eval`, `@mc_type`, `@mc_ast`, `@mc_code`, `@mc_error`, `@mc_get_env`

3. **å‰ç¼€çº¦å®š**ï¼š
   - `@mc_*`ï¼šå®ç¼–è¯‘æ—¶å‡½æ•°ï¼ˆMacro Compile-timeï¼‰
   - `@src_*`ï¼šæºä»£ç ä½ç½®ç›¸å…³ï¼ˆSourceï¼‰

---

## 9. æ€§èƒ½ä¿è¯

æ‰€æœ‰å†…ç½®å‡½æ•°éµå¾ª Uya çš„é›¶æˆæœ¬æŠ½è±¡åŸåˆ™ï¼š

| ç±»åˆ« | æ€§èƒ½ä¿è¯ |
|------|----------|
| **ç¼–è¯‘æœŸå±•å¼€** | `@size_of`, `@align_of`, `@len(æ•°ç»„)`, `@max`, `@min`, `@src_*`, `@func_name` |
| **é›¶è¿è¡Œæ—¶å¼€é”€** | ä¸Šè¿°å‡½æ•°åœ¨ç¼–è¯‘æ—¶å®Œå…¨æ±‚å€¼ï¼Œç”Ÿæˆå¸¸é‡ |
| **è¿è¡Œæ—¶è®¿é—®** | `@len(åˆ‡ç‰‡)` â†’ è®¿é—®åˆ‡ç‰‡çš„ `.len` å­—æ®µï¼ˆä¸€æ¬¡å†…å­˜è®¿é—®ï¼‰ |
| **å¯å˜å‚æ•°** | `@params` â†’ é›¶æŠ½è±¡å¼€é”€ï¼Œç›´æ¥æ˜ å°„åˆ° C `va_list` |

---

## 10. å¸¸è§ä½¿ç”¨æ¨¡å¼

### 10.1 è°ƒè¯•å’Œæ—¥å¿—

```uya
extern printf(fmt: *byte, ...) i32;

fn log(level: *byte, msg: *byte) void {
    printf("[%s] %s:%d in %s(): %s\n" as *byte,
           level,
           @src_name,
           @src_line,
           @func_name,
           msg);
}

fn main() i32 {
    log("INFO" as *byte, "Application started" as *byte);
    // è¾“å‡ºï¼š[INFO] main.uya:15 in main(): Application started
    return 0;
}
```

### 10.2 æ–­è¨€å®ç°

```uya
extern printf(fmt: *byte, ...) i32;
extern exit(code: i32) void;

fn assert(condition: bool, msg: *byte, file: *byte, line: i32, func: *byte) void {
    if !condition {
        printf("Assertion failed: %s\n" as *byte, msg);
        printf("  at %s:%d in %s()\n" as *byte, file, line, func);
        exit(1);
    }
}

fn main() i32 {
    const x: i32 = 10;
    
    if !(x > 0) {
        assert(false, 
               "x must be positive" as *byte,
               @src_name,
               @src_line,
               @func_name);
    }
    
    return 0;
}
```

### 10.3 æ³›å‹å®¹å™¨å¤§å°è®¡ç®—

```uya
struct Buffer<T> {
    data: [T: 1024],
    count: i32
}

fn buffer_info<T>() void {
    const elem_size: i32 = @size_of(T);
    const total_size: i32 = @size_of(Buffer<T>);
    const capacity: i32 = @len(Buffer<T>.data);
    
    printf("Element size: %d\n" as *byte, elem_size);
    printf("Buffer size: %d\n" as *byte, total_size);
    printf("Capacity: %d\n" as *byte, capacity);
}
```

---

## 11. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v0.1.0 | 2026-02-06 | æ–°å¢æºä»£ç ä½ç½®å‡½æ•°ï¼š`@src_name`, `@src_path`, `@src_line`, `@src_col`, `@func_name` |
| v0.1.0 | 2026-02-04 | åˆå§‹ç‰ˆæœ¬ï¼š`@size_of`, `@align_of`, `@len`, `@max`, `@min`, `@params`, å®ç³»ç»Ÿå‡½æ•°ï¼ˆè¯­æ³•ï¼‰ï¼Œå¼‚æ­¥å‡½æ•°ï¼ˆè¯­æ³•ï¼‰ |

---

## 12. å‚è€ƒæ–‡æ¡£

- [Uya è¯­è¨€è§„èŒƒ](../uya.md) - å®Œæ•´è¯­è¨€è§„èŒƒ
- [è¯­æ³•é€ŸæŸ¥](../grammar_quick.md) - è¯­æ³•é€ŸæŸ¥æ‰‹å†Œ
- [Uya Mini è§„èŒƒ](../compiler-mini/spec/UYA_MINI_SPEC.md) - å½“å‰å®ç°çš„å­é›†è§„èŒƒ
- [å‘è¡Œè¯´æ˜](../RELEASE_v0.1.0.md) - v0.1.0 ç‰ˆæœ¬è¯´æ˜

---

**æœ¬æ–‡æ¡£ç”± Uya ç¼–è¯‘å™¨å›¢é˜Ÿç»´æŠ¤ï¼Œæœ€åæ›´æ–°ï¼š2026-02-06**

