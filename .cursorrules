# Uya 项目 Cursor 规则文件

本文档包含 Uya 项目的开发规则和重要参考文档。

## 重要文档

### 编译器实现待办事项（v0.1.0）

项目 v0.1.0 已达成自举，详见 `docs/RELEASE_v0.1.0.md`。

**使用场景**：
- 开始新的实现任务前，先查看上述文档了解当前状态
- 实现功能后，同步更新相应待办文档

---

## 项目结构

- `docs/uya.md` - 完整语言规范
- `docs/grammar_formal.md` - 正式BNF语法规范
- `docs/grammar_quick.md` - 语法速查手册
- `docs/uya_ai_prompt.md` - AI代码生成提示词
- `docs/RELEASE_*.md` - 版本发布说明
- `docs/todo_mini_to_full.md` - 编译器实现待办事项
- `docs/compiler-c-spec/` - 编译器规范文档
- `compiler-c/` - Uya Mini 编译器源代码（C 实现）
- `src/` - Uya 自举编译器源代码（Uya 实现）
- `tests/` - 测试用例和测试脚本
- `bin/` - 编译器二进制输出目录（`uya-c` C编译器，`uya` 自举编译器）
- `lib/` - 标准库

---

## 开发规范

### 文件命名

- Markdown 文档使用小写文件名，单词间用下划线分隔：`todo_implementation.md`
- 代码文件遵循现有命名约定

### 代码风格

- C 代码使用 C99 标准
- 使用 `-Wall -Wextra -pedantic` 编译选项
- 遵循现有的代码风格和注释规范

---

## 编译器开发工作流

新增或修改语言特性时，按以下顺序进行：

### 1. 规范优先
- 更新 `docs/compiler-c-spec/UYA_MINI_SPEC.md`
- 定义类型、字面量、BNF、语义规则、C99 映射等

### 2. 测试先行
- 在 `tests/programs/` 添加测试用例（如 `test_xxx.uya`）
- 覆盖目标场景，返回 0 表示通过
- **测试验证要求**：每个测试用例必须同时通过 `--c99`（C 版编译器）和 `--uya --c99`（自举版编译器），二者都通过才算测试通过

#### 测试程序约定

- **测试文件命名**：
  - 正常测试：`test_xxx.uya`（测试通过时返回 0）
  - 预期编译失败：`error_xxx.uya`（以 `error_` 开头，测试脚本会自动识别为预期编译失败）
- **测试返回值**：
  - 测试通过应返回 0（退出码 0）
  - 测试失败应返回非 0（退出码表示错误类型）
  - 测试脚本通过 `bridge.c` 提供 `main` 函数，调用 `uya_main()`（Uya 的 `main` 函数被重命名为 `uya_main`）
- **多文件测试**：
  - 多文件测试放在 `tests/programs/multifile/` 或 `tests/programs/cross_deps/` 目录下
  - 测试脚本会自动收集目录下所有 `.uya` 文件一起编译
- **语法约定**：
  - `use` 语句只能在顶层使用，不能在函数体内
  - 结构体按值传递会被移动，移动后不能再次使用（需重新创建变量）
  - `export` 关键字用于标记可导出的项（函数、结构体等）

### 3. C 编译器实现
按编译流水线依次修改：Lexer → AST → Parser → Checker → C99 Codegen

### 4. 自举编译器同步
同步修改 `src/` 中对应模块，保持 C 版与 Uya 版行为一致。

### 5. 验证流程
```
cd compiler-c && make build                       # 构建 C 版编译器
./tests/run_programs.sh --c99 test_xxx.uya        # C 版测试（必须通过）
cd src && ./compile.sh --c99 -e                   # 构建自举编译器
./tests/run_programs.sh --uya --c99 test_xxx.uya  # 自举版测试（必须通过）
cd src && ./compile.sh --c99 -b                   # 自举对比（C 输出必须完全一致）
```
**要求**：新增或修改的测试用例必须保证 `--c99` 与 `--uya --c99` 两种方式均通过。

---

## AI 辅助开发提示

当进行编译器开发时：
1. 参考 `docs/RELEASE_v0.1.0.md` 了解当前状态
2. 参考 `docs/uya.md` 和 `docs/grammar_formal.md` 确认语法规范
3. 遵循上述「编译器开发工作流」

