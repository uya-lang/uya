# 数字字面量增强 - v0.2.31+

## 功能概述

为 Uya 编译器添加了数字字面量的多进制支持和下划线分隔符，提高代码可读性。

## 实现的功能

### 1. 多进制整数字面量

- **十六进制**：`0x` 或 `0X` 前缀
  - 示例：`0xFF`、`0x1A2B`、`0XDEAD_BEEF`
  
- **八进制**：`0o` 或 `0O` 前缀
  - 示例：`0o755`、`0O644`、`0o7_777`
  
- **二进制**：`0b` 或 `0B` 前缀
  - 示例：`0b1010`、`0B1111_0000`、`0b1111_0000_1010_0101`

- **十进制**：无前缀（保持原有行为）
  - 示例：`42`、`1_000_000`、`123_456_789`

### 2. 下划线分隔符

数字字面量中可以使用下划线 `_` 作为分隔符，提高可读性：

- **规则**：
  - 可以出现在任意两个数字之间
  - 不能出现在开头或结尾
  - 不能连续出现
  - 不能紧跟在进制前缀之后（如 `0x_FF` 非法，`0xFF_00` 合法）
  
- **适用范围**：
  - 整数字面量：`1_000_000`
  - 浮点字面量：`3.141_592_653`
  - 指数部分：`1.0e1_0`
  - 所有进制：`0xFF_00_AA`、`0o7_777`、`0b1111_0000`

### 3. 浮点字面量

浮点字面量也支持下划线分隔符（仅限十进制）：

- 小数部分：`1_000.5`
- 小数点后：`3.141_592_653`
- 指数部分：`1.0e1_0`

## 实现范围

### C 编译器 (`compiler-mini/src/`)

- ✅ **Lexer** (`src/lexer.c`)
  - 识别 `0x`/`0X`（十六进制）前缀
  - 识别 `0o`/`0O`（八进制）前缀
  - 识别 `0b`/`0B`（二进制）前缀
  - 支持下划线分隔符（带验证规则）
  - 错误检测（连续下划线、末尾下划线、前缀后下划线等）

- ✅ **Parser** (`src/parser.c`)
  - 添加 `remove_underscores()` 辅助函数
  - 添加 `parse_integer_literal()` 解析不同进制
  - 添加 `parse_float_literal()` 处理浮点下划线
  - 使用 `strtol()` 转换不同进制为内部表示

- ✅ **AST/Checker/Codegen**
  - 无需修改（整数在 Parser 阶段已转换为统一的十进制值）
  - Codegen 生成标准十进制 C 字面量

### 自举编译器 (`compiler-mini/uya-src/`)

- ⏸️ **待更新**（当前 C 编译器已完整实现）
  - 需要同步更新 `lexer.uya`
  - 需要同步更新 `parser.uya`

## 测试

### 测试文件

- `tests/programs/test_number_literals.uya`
  - 测试所有进制的整数字面量
  - 测试下划线分隔符
  - 测试浮点字面量（带下划线）
  - 验证运行时值的正确性

### 测试结果

```bash
cd compiler-mini
./tests/run_programs.sh --c99 test_number_literals.uya
# ✓ 测试通过
```

## 使用示例

```uya
fn main() i32 {
    // 多进制整数
    const hex: i32 = 0xFF_00_AA;      // 十六进制：16711850
    const oct: i32 = 0o755;            // 八进制：493
    const bin: i32 = 0b1111_0000;      // 二进制：240
    const dec: i32 = 1_000_000;        // 十进制：1000000
    
    // 浮点字面量（带下划线）
    const pi: f64 = 3.141_592_653;
    const big: f64 = 1_000.5;
    const sci: f64 = 1.0e1_0;          // 10000000000.0
    
    return 0;
}
```

## 规范文档

- `compiler-mini/spec/UYA_MINI_SPEC.md` § 3.2 数字字面量
  - 完整 BNF 语法
  - 下划线规则说明
  - 错误处理规则

## 兼容性

- ✅ 向后兼容（不使用新语法的代码仍然有效）
- ✅ 与 C99 互操作（生成标准十进制字面量）
- ✅ 所有原有测试通过

## 限制

1. 浮点字面量仅支持十进制（不支持 `0x1.0p10` 等十六进制浮点）
2. 自举编译器尚未同步更新（需手动更新 `uya-src/`）
3. 整数在解析阶段统一转为 `i32`，不保留原始进制信息

## 后续工作

- [ ] 同步更新自举编译器（`uya-src/lexer.uya`, `uya-src/parser.uya`）
- [ ] 验证 `--uya --c99` 编译路径
- [ ] 考虑添加 `u32`/`i64` 等后缀支持（如 `0xFFu32`）
- [ ] 考虑支持十六进制浮点字面量（`0x1.0p10`）

