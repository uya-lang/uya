// 测试泛型 - 综合测试（覆盖所有主要功能）

// ============================================
// 1. 泛型函数 - 各种形式
// ============================================

// 1.1 无约束泛型函数
fn identity<T>(x: T) T {
    return x;
}

// 1.2 多类型参数泛型函数
fn first<A, B>(a: A, b: B) A {
    return a;
}

fn second<A, B>(a: A, b: B) B {
    return b;
}

// 1.3 带约束泛型函数
fn max<T: Ord>(a: T, b: T) T {
    if a > b { return a; }
    return b;
}

fn min<T: Ord>(a: T, b: T) T {
    if a < b { return a; }
    return b;
}

// 1.4 泛型函数操作指针
fn swap<T>(a: &T, b: &T) void {
    const temp: T = *a;
    *a = *b;
    *b = temp;
}

// ============================================
// 2. 泛型结构体 - 各种形式
// ============================================

// 2.1 单类型参数结构体
struct Box<T> {
    value: T,
}

// 2.2 多类型参数结构体
struct Pair<K, V> {
    key: K,
    value: V,
}

// 2.3 带约束的泛型结构体
struct Container<T: Default> {
    data: T,
    valid: bool,
}

// ============================================
// 3. 主测试函数
// ============================================

fn main() i32 {
    // --- 测试泛型函数 ---
    
    // 测试 identity
    const id1: i32 = identity<i32>(42);
    if id1 != 42 {
        return 1;
    }
    const id2: bool = identity<bool>(true);
    if id2 != true {
        return 2;
    }
    
    // 测试多类型参数（结果先存储到变量）
    const f1: i32 = first<i32, i64>(10, 20);
    if f1 != 10 {
        return 3;
    }
    const s1: i64 = second<i32, i64>(10, 20);
    if s1 != 20 {
        return 4;
    }
    
    // 测试带约束函数
    const m1: i32 = max<i32>(10, 20);
    if m1 != 20 {
        return 5;
    }
    const m2: i32 = min<i32>(10, 20);
    if m2 != 10 {
        return 6;
    }
    
    // 测试 swap
    var a: i32 = 100;
    var b: i32 = 200;
    swap<i32>(&a, &b);
    if a != 200 {
        return 7;
    }
    if b != 100 {
        return 8;
    }
    
    // --- 测试泛型结构体 ---
    
    // 测试 Box
    const box1: Box<i32> = Box<i32>{ value: 999 };
    if box1.value != 999 {
        return 9;
    }
    
    // 测试 Pair
    const pair1: Pair<i32, bool> = Pair<i32, bool>{ key: 42, value: true };
    if pair1.key != 42 {
        return 10;
    }
    if pair1.value != true {
        return 11;
    }
    
    // 测试带约束结构体
    const container1: Container<i32> = Container<i32>{ data: 123, valid: true };
    if container1.data != 123 {
        return 12;
    }
    if container1.valid != true {
        return 13;
    }
    
    // --- 测试多实例化 ---
    
    // 同一泛型类型多次实例化
    const i1: i32 = identity<i32>(1);
    const i2: i64 = identity<i64>(2);
    const i3: i8 = identity<i8>(3);
    if i1 != 1 {
        return 14;
    }
    if i2 != 2 {
        return 15;
    }
    if i3 != 3 {
        return 16;
    }
    
    // --- 测试嵌套泛型调用 ---
    const nested: i32 = identity<i32>(identity<i32>(identity<i32>(42)));
    if nested != 42 {
        return 17;
    }
    
    // --- 测试泛型在表达式中 ---
    const id_val: i32 = identity<i32>(10);
    const max_val: i32 = max<i32>(5, 3);
    const expr_result: i32 = id_val + max_val;
    if expr_result != 15 {
        return 18;
    }
    
    return 0;
}
