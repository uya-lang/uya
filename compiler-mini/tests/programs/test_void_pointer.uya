// &void 通用指针类型测试程序
// 测试 &void 类型的功能：类型擦除、类型恢复、指针转换

struct Point {
    x: i32,
    y: i32,
}

struct Data {
    value: i32,
}

fn main() i32 {
    // 测试1：&void 指针声明和初始化
    var void_ptr: &void = null;
    if void_ptr != null {
        return 1;  // void_ptr 应该是 null
    }
    
    // 测试2：具体指针转换为 &void（类型擦除）
    var x: i32 = 42;
    var i32_ptr: &i32 = &x;
    void_ptr = i32_ptr as &void;
    if void_ptr == null {
        return 2;  // void_ptr 不应该是 null
    }
    
    // 测试3：&void 转换为具体指针（类型恢复）
    var recovered_i32_ptr: &i32 = void_ptr as &i32;
    if recovered_i32_ptr == null {
        return 3;  // recovered_i32_ptr 不应该是 null
    }
    if *recovered_i32_ptr != 42 {
        return 4;  // 恢复后的指针应该指向值 42
    }
    
    // 测试4：结构体指针转换为 &void
    var p: Point = Point{ x: 10, y: 20 };
    var point_ptr: &Point = &p;
    void_ptr = point_ptr as &void;
    if void_ptr == null {
        return 5;  // void_ptr 不应该是 null
    }
    
    // 测试5：&void 转换为结构体指针
    var recovered_point_ptr: &Point = void_ptr as &Point;
    if recovered_point_ptr == null {
        return 6;  // recovered_point_ptr 不应该是 null
    }
    if recovered_point_ptr.x != 10 || recovered_point_ptr.y != 20 {
        return 7;  // 恢复后的指针应该指向正确的结构体
    }
    
    // 测试6：多个不同类型的指针通过 &void 传递
    var d: Data = Data{ value: 100 };
    var data_ptr: &Data = &d;
    void_ptr = data_ptr as &void;
    
    var recovered_data_ptr: &Data = void_ptr as &Data;
    if recovered_data_ptr.value != 100 {
        return 8;  // 恢复后的指针应该指向正确的值
    }
    
    // 测试7：&void 指针比较
    var void_ptr2: &void = null;
    if void_ptr == void_ptr2 {
        return 9;  // void_ptr 不应该是 null，void_ptr2 是 null
    }
    
    void_ptr2 = i32_ptr as &void;
    if void_ptr == void_ptr2 {
        return 10;  // 两个 &void 指针应该不相等（指向不同地址）
    }
    
    // 测试8：&void 指针作为函数参数（模拟通用指针操作）
    // 注意：这里只是测试 &void 类型本身，不涉及函数调用
    
    // 测试9：&void 指针的 sizeof
    const void_ptr_size: i32 = sizeof(&void);
    const i32_ptr_size: i32 = sizeof(&i32);
    if void_ptr_size != i32_ptr_size {
        return 11;  // &void 指针大小应该与其他指针大小相同
    }
    
    // 测试10：&void 指针的 alignof
    const void_ptr_align: i32 = alignof(&void);
    const i32_ptr_align: i32 = alignof(&i32);
    if void_ptr_align != i32_ptr_align {
        return 12;  // &void 指针对齐应该与其他指针对齐相同
    }
    
    // 测试11：&void 指针解引用（需要先转换为具体类型）
    // 注意：&void 不能直接解引用，必须先转换为具体类型
    var y: i32 = 200;
    var y_ptr: &i32 = &y;
    void_ptr = y_ptr as &void;
    var z_ptr: &i32 = void_ptr as &i32;
    if *z_ptr != 200 {
        return 13;  // 通过 &void 转换后解引用应该得到正确值
    }
    
    // 所有测试通过
    return 0;
}

