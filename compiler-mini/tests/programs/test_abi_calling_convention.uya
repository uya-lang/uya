// 函数调用约定（ABI）测试程序
// 测试各种参数传递和返回值传递方式，验证与 C ABI 的兼容性
// 根据 UYA_MINI_SPEC.md 5.5 节的调用约定规范

// ========== 测试结构体定义 ==========

// 小结构体（8字节，应该用寄存器传递）
struct SmallStruct {
    x: i32,
    y: i32,
}

// 中等结构体（16字节，在 x86-64 System V 中应该用寄存器传递）
struct MediumStruct {
    a: i32,
    b: i32,
    c: i32,
    d: i32,
}

// 大结构体（24字节，应该用指针传递）
struct LargeStruct {
    a: i32,
    b: i32,
    c: i32,
    d: i32,
    e: i32,
    f: i32,
}

// 更大的结构体（32字节，应该用指针传递）
struct VeryLargeStruct {
    a: i32,
    b: i32,
    c: i32,
    d: i32,
    e: i32,
    f: i32,
    g: i32,
    h: i32,
}

// ========== 测试 1: 小结构体参数传递（寄存器传递） ==========

fn test_small_struct_param(s: SmallStruct) i32 {
    if s.x != 10 || s.y != 20 {
        return 1;
    }
    return 0;
}

fn test_small_struct_param_call() i32 {
    const s: SmallStruct = SmallStruct{ x: 10, y: 20 };
    const result: i32 = test_small_struct_param(s);
    return result;
}

// ========== 测试 2: 中等结构体参数传递（寄存器传递，x86-64 System V） ==========

fn test_medium_struct_param(m: MediumStruct) i32 {
    if m.a != 1 || m.b != 2 || m.c != 3 || m.d != 4 {
        return 1;
    }
    return 0;
}

fn test_medium_struct_param_call() i32 {
    const m: MediumStruct = MediumStruct{ a: 1, b: 2, c: 3, d: 4 };
    const result: i32 = test_medium_struct_param(m);
    return result;
}

// ========== 测试 3: 大结构体参数传递（指针传递） ==========

fn test_large_struct_param(l: LargeStruct) i32 {
    if l.a != 1 || l.b != 2 || l.c != 3 || l.d != 4 || l.e != 5 || l.f != 6 {
        return 1;
    }
    return 0;
}

fn test_large_struct_param_call() i32 {
    const l: LargeStruct = LargeStruct{ a: 1, b: 2, c: 3, d: 4, e: 5, f: 6 };
    const result: i32 = test_large_struct_param(l);
    return result;
}

// ========== 测试 4: 小结构体返回值（寄存器返回） ==========

fn test_small_struct_return() SmallStruct {
    return SmallStruct{ x: 100, y: 200 };
}

fn test_small_struct_return_call() i32 {
    const s: SmallStruct = test_small_struct_return();
    if s.x != 100 || s.y != 200 {
        return 1;
    }
    return 0;
}

// ========== 测试 5: 中等结构体返回值（寄存器返回，x86-64 System V） ==========

fn test_medium_struct_return() MediumStruct {
    return MediumStruct{ a: 10, b: 20, c: 30, d: 40 };
}

fn test_medium_struct_return_call() i32 {
    const m: MediumStruct = test_medium_struct_return();
    if m.a != 10 || m.b != 20 || m.c != 30 || m.d != 40 {
        return 1;
    }
    return 0;
}

// ========== 测试 6: 大结构体返回值（sret 指针返回） ==========

fn test_large_struct_return() LargeStruct {
    return LargeStruct{ a: 1, b: 2, c: 3, d: 4, e: 5, f: 6 };
}

fn test_large_struct_return_call() i32 {
    const l: LargeStruct = test_large_struct_return();
    if l.a != 1 || l.b != 2 || l.c != 3 || l.d != 4 || l.e != 5 || l.f != 6 {
        return 1;
    }
    return 0;
}

// ========== 测试 7: 混合参数类型 ==========

fn test_mixed_params(a: i32, s: SmallStruct, b: i32) i32 {
    if a != 1 || s.x != 10 || s.y != 20 || b != 2 {
        return 1;
    }
    return 0;
}

fn test_mixed_params_call() i32 {
    const s: SmallStruct = SmallStruct{ x: 10, y: 20 };
    const result: i32 = test_mixed_params(1, s, 2);
    return result;
}

// ========== 测试 8: 多个小结构体参数 ==========

fn test_multiple_small_structs(s1: SmallStruct, s2: SmallStruct) i32 {
    if s1.x != 1 || s1.y != 2 || s2.x != 3 || s2.y != 4 {
        return 1;
    }
    return 0;
}

fn test_multiple_small_structs_call() i32 {
    const s1: SmallStruct = SmallStruct{ x: 1, y: 2 };
    const s2: SmallStruct = SmallStruct{ x: 3, y: 4 };
    const result: i32 = test_multiple_small_structs(s1, s2);
    return result;
}

// ========== 测试 9: 结构体参数和返回值组合 ==========

fn test_struct_param_and_return(s: SmallStruct) SmallStruct {
    return SmallStruct{ x: s.x * 2, y: s.y * 2 };
}

fn test_struct_param_and_return_call() i32 {
    const input: SmallStruct = SmallStruct{ x: 5, y: 10 };
    const output: SmallStruct = test_struct_param_and_return(input);
    if output.x != 10 || output.y != 20 {
        return 1;
    }
    return 0;
}

// ========== 测试 10: 递归调用中的结构体传递 ==========

fn test_recursive_struct(n: i32, s: SmallStruct) i32 {
    if n <= 0 {
        return s.x + s.y;
    }
    const new_s: SmallStruct = SmallStruct{ x: s.x + 1, y: s.y + 1 };
    return test_recursive_struct(n - 1, new_s);
}

fn test_recursive_struct_call() i32 {
    const s: SmallStruct = SmallStruct{ x: 1, y: 2 };
    const result: i32 = test_recursive_struct(2, s);
    // 递归 2 次: (1,2) -> (2,3) -> (3,4), 返回 3+4=7
    if result != 7 {
        return 1;
    }
    return 0;
}

// ========== 测试 11: 与 C 代码互操作 - 声明外部函数 ==========

// 声明外部 C 函数，用于验证 ABI 兼容性
extern fn c_small_struct_param(s: SmallStruct) i32;
extern fn c_medium_struct_param(m: MediumStruct) i32;
extern fn c_large_struct_param(l: LargeStruct) i32;
extern fn c_small_struct_return() SmallStruct;
extern fn c_medium_struct_return() MediumStruct;
extern fn c_large_struct_return() LargeStruct;
extern fn c_mixed_params(a: i32, s: SmallStruct, b: i32) i32;

// ========== 测试 12: 调用 C 函数 - 小结构体参数 ==========

fn test_c_small_struct_param() i32 {
    const s: SmallStruct = SmallStruct{ x: 100, y: 200 };
    const result: i32 = c_small_struct_param(s);
    // C 函数应该返回 s.x + s.y = 300
    if result != 300 {
        return 1;
    }
    return 0;
}

// ========== 测试 13: 调用 C 函数 - 中等结构体参数 ==========

fn test_c_medium_struct_param() i32 {
    const m: MediumStruct = MediumStruct{ a: 1, b: 2, c: 3, d: 4 };
    const result: i32 = c_medium_struct_param(m);
    // C 函数应该返回 a+b+c+d = 10
    if result != 10 {
        return 1;
    }
    return 0;
}

// ========== 测试 14: 调用 C 函数 - 大结构体参数 ==========

fn test_c_large_struct_param() i32 {
    const l: LargeStruct = LargeStruct{ a: 1, b: 2, c: 3, d: 4, e: 5, f: 6 };
    const result: i32 = c_large_struct_param(l);
    // C 函数应该返回 a+b+c+d+e+f = 21
    if result != 21 {
        return 1;
    }
    return 0;
}

// ========== 测试 15: 调用 C 函数 - 小结构体返回值 ==========

fn test_c_small_struct_return() i32 {
    const s: SmallStruct = c_small_struct_return();
    // C 函数应该返回 { x: 50, y: 60 }
    if s.x != 50 || s.y != 60 {
        return 1;
    }
    return 0;
}

// ========== 测试 16: 调用 C 函数 - 中等结构体返回值 ==========

fn test_c_medium_struct_return() i32 {
    const m: MediumStruct = c_medium_struct_return();
    // C 函数应该返回 { a: 11, b: 22, c: 33, d: 44 }
    if m.a != 11 || m.b != 22 || m.c != 33 || m.d != 44 {
        return 1;
    }
    return 0;
}

// ========== 测试 17: 调用 C 函数 - 大结构体返回值 ==========

fn test_c_large_struct_return() i32 {
    const l: LargeStruct = c_large_struct_return();
    // C 函数应该返回 { a: 1, b: 2, c: 3, d: 4, e: 5, f: 6 }
    if l.a != 1 || l.b != 2 || l.c != 3 || l.d != 4 || l.e != 5 || l.f != 6 {
        return 1;
    }
    return 0;
}

// ========== 测试 18: 调用 C 函数 - 混合参数 ==========

fn test_c_mixed_params() i32 {
    const s: SmallStruct = SmallStruct{ x: 7, y: 8 };
    const result: i32 = c_mixed_params(5, s, 6);
    // C 函数应该返回 5 + 7 + 8 + 6 = 26
    if result != 26 {
        return 1;
    }
    return 0;
}

// ========== 主测试函数 ==========

fn main() i32 {
    // 测试 1: 小结构体参数传递
    const result1: i32 = test_small_struct_param_call();
    if result1 != 0 {
        return 10 + result1;
    }
    
    // 测试 2: 中等结构体参数传递
    const result2: i32 = test_medium_struct_param_call();
    if result2 != 0 {
        return 20 + result2;
    }
    
    // 测试 3: 大结构体参数传递
    const result3: i32 = test_large_struct_param_call();
    if result3 != 0 {
        return 30 + result3;
    }
    
    // 测试 4: 小结构体返回值
    const result4: i32 = test_small_struct_return_call();
    if result4 != 0 {
        return 40 + result4;
    }
    
    // 测试 5: 中等结构体返回值
    const result5: i32 = test_medium_struct_return_call();
    if result5 != 0 {
        return 50 + result5;
    }
    
    // 测试 6: 大结构体返回值
    const result6: i32 = test_large_struct_return_call();
    if result6 != 0 {
        return 60 + result6;
    }
    
    // 测试 7: 混合参数类型
    const result7: i32 = test_mixed_params_call();
    if result7 != 0 {
        return 70 + result7;
    }
    
    // 测试 8: 多个小结构体参数
    const result8: i32 = test_multiple_small_structs_call();
    if result8 != 0 {
        return 80 + result8;
    }
    
    // 测试 9: 结构体参数和返回值组合
    const result9: i32 = test_struct_param_and_return_call();
    if result9 != 0 {
        return 90 + result9;
    }
    
    // 测试 10: 递归调用中的结构体传递
    const result10: i32 = test_recursive_struct_call();
    if result10 != 0 {
        return 100 + result10;
    }
    
    // 测试 12: 调用 C 函数 - 小结构体参数
    const result12: i32 = test_c_small_struct_param();
    if result12 != 0 {
        return 120 + result12;
    }
    
    // 测试 13: 调用 C 函数 - 中等结构体参数
    const result13: i32 = test_c_medium_struct_param();
    if result13 != 0 {
        return 130 + result13;
    }
    
    // 测试 14: 调用 C 函数 - 大结构体参数
    const result14: i32 = test_c_large_struct_param();
    if result14 != 0 {
        return 140 + result14;
    }
    
    // 测试 15: 调用 C 函数 - 小结构体返回值
    const result15: i32 = test_c_small_struct_return();
    if result15 != 0 {
        return 150 + result15;
    }
    
    // 测试 16: 调用 C 函数 - 中等结构体返回值
    const result16: i32 = test_c_medium_struct_return();
    if result16 != 0 {
        return 160 + result16;
    }
    
    // 测试 17: 调用 C 函数 - 大结构体返回值
    const result17: i32 = test_c_large_struct_return();
    if result17 != 0 {
        return 170 + result17;
    }
    
    // 测试 18: 调用 C 函数 - 混合参数
    const result18: i32 = test_c_mixed_params();
    if result18 != 0 {
        return 180 + result18;
    }
    
    // 所有测试通过
    return 0;
}

