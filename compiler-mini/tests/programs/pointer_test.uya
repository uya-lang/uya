// 指针类型测试程序
// 测试指针类型功能（函数参数、取地址、解引用、结构体指针）

struct Point {
    x: i32,
    y: i32,
}

// 全局变量用于测试返回指针
var global_value: i32 = 100;

// 测试1：指针类型函数参数和通过指针修改值
fn set_value(p: &i32, value: i32) void {
    // 通过指针解引用修改值
    *p = value;
}

// 测试2：指针类型函数参数和读取值
fn get_value(p: &i32) i32 {
    // 通过指针解引用读取值
    return *p;
}

// 测试3：指针类型作为函数返回值（返回全局变量的地址）
fn get_global_pointer() &i32 {
    return &global_value;
}

// 测试4：结构体指针参数和字段访问
fn get_point_x(p: &Point) i32 {
    // 使用语法糖 ptr.field 访问字段（等价于 (*ptr).field）
    return p.x;
}

// 测试5：结构体指针参数和字段修改
fn set_point(p: &Point, x: i32, y: i32) void {
    // 通过指针访问和修改结构体字段
    p.x = x;
    p.y = y;
}

fn main() i32 {
    // 测试1：sizeof 指针类型
    const ptr_size: i32 = sizeof(&i32);
    if ptr_size != 8 {
        return 1;  // 指针应该是 8 字节（64位平台）
    }
    
    // 测试2：指针变量声明和初始化（使用取地址运算符）
    var x: i32 = 42;
    var p: &i32 = &x;
    
    // 测试3：指针比较（与 null 比较）
    if p == null {
        return 1;  // p 不应该是 null
    }
    if p != null {
        // 正确，继续测试
    } else {
        return 1;
    }
    
    // 测试4：指针解引用读取值
    const value: i32 = *p;
    if value != 42 {
        return 1;  // 解引用应该得到 42
    }
    
    // 测试5：通过指针修改值
    set_value(p, 100);
    if x != 100 {
        return 1;  // x 应该被修改为 100
    }
    
    // 测试6：通过指针读取值（使用函数）
    const read_value: i32 = get_value(p);
    if read_value != 100 {
        return 1;  // 应该读取到 100
    }
    
    // 测试7：指针变量重新赋值（赋值给另一个变量的地址）
    var y: i32 = 200;
    p = &y;
    if *p != 200 {
        return 1;  // p 现在应该指向 y
    }
    
    // 测试8：指针比较（两个指针比较）
    var p2: &i32 = &y;
    if p != p2 {
        return 1;  // p 和 p2 应该指向同一个变量
    }
    var p3: &i32 = &x;
    if p == p3 {
        return 1;  // p 和 p3 不应该相等（指向不同变量）
    }
    
    // 测试9：null 指针初始化
    var null_ptr: &i32 = null;
    if null_ptr != null {
        return 1;  // null_ptr 应该是 null
    }
    
    // 测试10：指针类型函数返回值
    var global_ptr: &i32 = get_global_pointer();
    if global_ptr == null {
        return 1;  // 不应该返回 null
    }
    if *global_ptr != 100 {
        return 1;  // 全局变量值应该是 100
    }
    
    // 测试11：结构体指针参数和字段访问
    var point: Point = Point{ x: 10, y: 20 };
    var point_ptr: &Point = &point;
    
    const x_val: i32 = get_point_x(point_ptr);
    if x_val != 10 {
        return 1;  // 应该得到 10
    }
    
    // 测试12：通过结构体指针访问字段（使用语法糖）
    if point_ptr.x != 10 || point_ptr.y != 20 {
        return 1;  // 字段访问应该正确
    }
    
    // 测试13：通过结构体指针修改字段
    set_point(point_ptr, 30, 40);
    if point.x != 30 || point.y != 40 {
        return 1;  // 字段应该被修改
    }
    
    // 测试14：直接通过指针修改结构体字段
    point_ptr.x = 50;
    point_ptr.y = 60;
    if point.x != 50 || point.y != 60 {
        return 1;  // 字段应该被修改
    }
    
    // 所有测试通过
    return 0;
}
