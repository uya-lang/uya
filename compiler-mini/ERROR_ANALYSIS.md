# 编译错误归类分析

## 错误统计概览

总计：约580个错误

### 按错误类型分类（从多到少）

1. **表达式类型不匹配** (节点类型: 25, AST_BINARY_EXPR): **192个错误**
   - 问题：二元表达式的类型检查过于严格
   - 位置：ast.uya, parser.uya, lexer.uya等
   - 示例：`/media/winger/_dde_home/winger/uya/compiler-mini/uya-src/ast.uya:(257:36)`

2. **未定义的变量** (节点类型: 25, AST_BINARY_EXPR): **99个错误**
   - 问题：标识符查找失败，可能是符号表或作用域问题
   - 位置：parser.uya, checker.uya, codegen.uya
   - 示例：`/media/winger/_dde_home/winger/uya/compiler-mini/uya-src/parser.uya:(636:13)`

3. **类型检查错误** (节点类型: 18, AST_VAR_DECL): **75个错误**
   - 问题：变量声明类型检查失败
   - 位置：多个文件
   - 可能原因：类型推断失败或类型不匹配

4. **变量初始化表达式类型不匹配**: **144个错误**
   - 节点类型分布：
     - 节点类型 25: 42个
     - 节点类型 18: 36个
     - 节点类型 16: 28个
     - 节点类型 17: 17个
     - 节点类型 26: 6个
     - 节点类型 20: 1个
   - 问题：初始化表达式类型与变量类型不匹配

5. **不支持的指针类型转换** (节点类型: 24, AST_CAST_EXPR): **12个错误**
   - 问题：指针类型转换不支持
   - 位置：lexer.uya, parser.uya等
   - 需要：扩展类型转换支持

6. **无法访问字段：对象类型推断失败** (节点类型: 17, AST_STRUCT_DECL): **多个错误**
   - 问题：访问ASTNode字段时，类型检查器无法推断对象的具体类型
   - 字段包括：var_decl_type, name, type_named_name, inc_bb, end_bb, cond_bb等
   - 根本原因：Uya编译器不支持类型缩小（type narrowing）

7. **表达式类型不匹配** (其他节点类型):
   - 节点类型 17 (AST_STRUCT_DECL): 9个
   - 节点类型 26 (AST_ARRAY_LITERAL): 8个
   - 节点类型 24 (AST_CAST_EXPR): 3个
   - 节点类型 15 (AST_STRING): 3个
   - 节点类型 18 (AST_VAR_DECL): 2个

8. **结构体字段访问错误**:
   - "结构体 'ASTNode' 中没有字段 'fn_decl_params'": 2个
   - "结构体 'ASTNode' 中没有字段 'struct_decl_fields'": 1个

9. **其他错误**:
   - 全局变量生成失败: MAX_BLOCK_STMTS: 1个
   - 类型检查错误 (节点类型: 19): 1个
   - 代码生成失败: 1个

## 修复优先级

### P0 - 高优先级（阻塞编译）
1. ✅ **数组类型字段检查** - 已完成
2. **表达式类型不匹配** (AST_BINARY_EXPR, 192个) - 影响面最大
3. **未定义的变量** (99个) - 符号查找问题

### P1 - 中优先级
4. **类型检查错误** (AST_VAR_DECL, 75个)
5. **变量初始化表达式类型不匹配** (144个)
6. **无法访问字段：对象类型推断失败** - 需要类型缩小支持

### P2 - 低优先级
7. **不支持的指针类型转换** (12个)
8. **结构体字段访问错误** (3个)
9. **其他错误** (3个)

## 根本原因分析

### 主要问题
1. **类型缩小（Type Narrowing）不支持**
   - 即使有 `if (node.type == AST_PROGRAM)` 检查，类型检查器仍将 `node` 视为联合类型
   - 导致无法安全访问特定字段

2. **类型检查过于严格**
   - 二元表达式的类型匹配可能过于严格
   - 需要更宽松的类型匹配规则

3. **符号查找问题**
   - 未定义的变量可能是作用域或符号表问题

4. **指针类型转换支持不足**
   - 需要扩展类型转换支持

## 修复策略

1. **改进类型检查器**
   - 支持类型缩小（type narrowing）
   - 放宽类型匹配规则
   - 改进符号查找

2. **扩展类型转换支持**
   - 支持指针类型转换
   - 改进类型转换检查

3. **修复字段访问**
   - 改进联合类型字段访问的类型检查


