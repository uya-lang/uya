# Uya v0.2.1 版本说明

**发布日期**：2026-01-31

本版本在 v0.2.0 基础上新增 **重复数组字面量** `[value: N]`，与数组类型语法 `[T: N]` 统一使用冒号，和完整 Uya 规范（uya.md 0.34）一致。C 编译器与自举编译器已同步实现，并通过自举对比验证。

---

## 核心亮点

### 重复数组字面量 `[value: N]`

- **语法**：`[value: N]` 表示将 `value` 重复 `N` 次构成的数组字面量，与数组类型 `[T: N]` 一致使用冒号表示「内容 : 长度」。
- **约束**：`N` 须为编译期常量（字面量或顶层 `const`）。
- **类型**：与列表形式 `[a, b, c]` 相同，需与左侧变量类型匹配（如 `var arr: [i32: 5] = [0: 5];`）。
- **示例**：`[0: 5]` 等价于 `[0, 0, 0, 0, 0]`，`[42: 3]` 等价于 `[42, 42, 42]`。

---

## 主要变更

### 数组字面量形式（本版本完整支持）

| 形式 | 说明 |
|------|------|
| `[expr1, expr2, ...]` | 列表形式，元素类型从首元素推断，长度从元素个数推断 |
| `[value: N]` | 重复形式，`value` 重复 `N` 次，`N` 为编译期常量 |
| `[]` | 空字面量，仅当左侧类型已指定时可用（未初始化） |

### 与 v0.2.0 的差异

| 项目 | v0.2.0 | v0.2.1 |
|------|--------|--------|
| 数组字面量 | 仅支持 `[expr, ...]` 与 `[]` | **新增** `[value: N]` 重复形式 |

---

## 实现范围

| 模块 | C 编译器 | 自举编译器 |
|------|----------|------------|
| 规范 | UYA_MINI_SPEC 已含 `array_literal = '[' expr_list ']' \| '[' expr ':' expr ']'` | — |
| 词法 | 无变更（沿用 `[`、`:`、`]`） | ✓ |
| AST | `AST_ARRAY_LITERAL` 支持 `repeat_count_expr` 表示 `[value: N]` | ✓ |
| 语法 | `array_literal` 解析 `[expr : expr]` 分支 | ✓ |
| 类型检查 | `[value: N]` 的 N 编译期求值、类型与长度校验 | ✓ |
| C99 后端 | 重复形式生成对应 C 初始化列表或逐元素初始化 | ✓ |

---

## 验证

### 测试

```bash
# C 版编译器
./tests/run_programs.sh --c99 test_array_repeat.uya

# 自举编译器
./tests/run_programs.sh --uya --c99 test_array_repeat.uya
```

### 自举对比

```bash
cd compiler-mini/uya-src
./compile.sh --c99 -b    # C 输出与自举输出逐字节一致 ✓
```

所有测试用例需同时通过 `--c99` 与 `--uya --c99`（见 `.cursorrules` 验证流程）。

---

## 已知限制与后续方向

- **本版本未包含**：元组类型、错误处理、defer/errdefer、切片、match 等（见 `compiler-mini/todo_mini_to_full.md`）。
- **后续计划**：在稳定 0.2.1 基础上，按待办顺序继续实现错误处理、defer/errdefer、切片等特性。

---

## 致谢

感谢所有参与 Uya Mini 重复数组字面量实现、测试与文档工作的贡献者。

---

## 附录：版本与仓库

- **版本**：v0.2.1
- **基于**：v0.2.0
- **仓库**：<https://github.com/uya-lang/uya>
- **许可**：MIT（见 [LICENSE](LICENSE)）
