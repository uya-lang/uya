# Uya 编译器实现待办事项

本文档记录尚未完成或部分完成的功能实现。

**最后更新**：2026-01-09  
**基于规范版本**：Uya 0.26

---

## 优先级说明

- **P0（高优先级）**：规范已更新但编译器未实现的破坏性变更，影响代码兼容性
- **P1（中高优先级）**：核心功能缺失，影响语言完整性
- **P2（中优先级）**：有用功能，提升开发体验
- **P3（低优先级）**：可选功能或实现细节优化

---

## P1：核心功能缺失

### 4. 模块系统 ❌

**状态**：❌ **未实现**

**规范要求**（`uya.md` 第 1.5 章）：
- 目录级模块系统
- 显式导出 `export` 关键字
- 路径导入 `use` 关键字
- 模块路径：`module_path = ID { '.' ID }`

**影响**：当前只支持单文件编译，无法使用模块系统

**待办事项**：
- [ ] 词法分析器：确认 `export` 和 `use` 关键字支持（可能已支持）
- [ ] 语法分析器：
  - [ ] 实现 `export_decl` 解析
  - [ ] 实现 `import_stmt` 解析（`use module_path [ as ID ] ;`）
- [ ] 模块解析器（新建）：
  - [ ] 目录扫描和模块路径映射
  - [ ] 模块依赖解析
  - [ ] 循环依赖检测
- [ ] 符号表扩展：
  - [ ] 模块级别的符号表
  - [ ] 导出符号管理
  - [ ] 导入符号解析
- [ ] 类型检查器：
  - [ ] 跨模块类型检查
  - [ ] 导出符号可见性检查
- [ ] IR 生成器：
  - [ ] 模块信息的 IR 表示
- [ ] 代码生成器：
  - [ ] 多文件代码生成
  - [ ] 模块前缀处理（如 `std.io.read_file`）

**相关文件**：
- 需要新建：`compiler/src/module/` 目录
- `compiler/src/parser/parser.c`
- `compiler/src/checker/typechecker.c`
- `compiler/src/codegen/codegen_main.c`

**参考**：
- 规范：`uya.md` 第 1.5 章（模块系统）
- 语法：`grammar_formal.md` 第 7 章（模块系统）

**优先级说明**：虽然重要，但可以分阶段实现，先实现单文件编译的完善功能

---

## P2：有用功能，提升开发体验

### 7. 元组类型 ⚠️

**状态**：⚠️ **部分实现**

**规范要求**：
- 元组类型：`(T1, T2, ...)`
- 元组字面量：`(expr1, expr2, ...)`
- 元组字段访问：`tuple.0`, `tuple.1`, ...
- 元组模式匹配：`(pattern1, pattern2, ...)`

**已完成事项**：
- [x] 语法分析器：
  - [x] 添加 `AST_TYPE_TUPLE` 节点类型（`ast.h`）
  - [x] 添加 `AST_TUPLE_LITERAL` 节点类型（`ast.h`）
  - [x] 实现元组类型解析（`parser_parse_type`）
  - [x] 实现元组字面量解析（`parser_parse_expression`）
  - [x] 实现元组字段访问解析（`.0`, `.1`, ...）- 语法解析已完成（使用 `AST_MEMBER_ACCESS` 节点，支持 `.NUM` 语法）
- [x] 类型系统：
  - [x] 添加元组类型支持（使用 `IR_TYPE_STRUCT` 作为占位符）
- [x] 类型检查器：
  - [x] 元组类型匹配
  - [x] 元组字段访问基础类型检查（识别数字索引的成员访问）
  - [x] 元组字面量的类型检查（递归检查所有元素表达式）
  - [ ] 元组字段索引范围检查 - 需要完整的类型系统支持
  - [ ] 元组类型声明的类型检查错误修复（存在"未定义的变量 'i32'"错误）
- [x] IR 生成器：
  - [x] 元组类型的 IR 表示
  - [x] 元组字面量的 IR 生成（已完善：生成完整的结构体初始化 `IR_STRUCT_INIT`，字段名为 "_0", "_1", "_2" 等）
  - [x] 元组字段访问的 IR 生成（使用 `IR_MEMBER_ACCESS` 指令）
  - [x] 元组类型的结构体定义生成（`IR_STRUCT_DECL`）- ✅ 已完成：实现了 `generate_tuple_type_name` 和 `ensure_tuple_struct_decl` 函数，能够为每个元组类型生成唯一的结构体定义（如 `tuple_i32_bool`）
- [x] 代码生成器：
  - [x] 元组类型的 C 代码生成（使用结构体表示）
  - [x] 元组字段访问的代码生成（生成 `._0`, `._1` 形式的字段访问）
  - [x] 元组结构体定义的代码生成 - ✅ 已完成：结构体定义现在可以正确生成（如 `tuple_i32_bool`、`tuple_i32_f64_bool` 等）
  - [x] 元组字面量初始化表达式的类型名称修复 - ✅ 已完成：在 IR 生成阶段，当变量声明类型是元组类型时，自动更新元组字面量的结构体名称为正确的类型名称
- [x] 测试用例：
  - [x] 基本元组使用（`test_tuple_feature.uya` 和 `test_tuple_comprehensive.uya`）
  - [x] 元组字段访问（在表达式中使用，如 `pair.0 == 42`）
  - [ ] 元组模式匹配（match 表达式功能未完成）

**待办事项**：
- [ ] 类型检查器：
  - [x] 元组字段索引范围检查 - ✅ 已完成（2026-01-09）
  - [x] 元组类型声明的类型检查错误修复 - ✅ 已验证：测试文件显示功能正常，错误可能已修复或不存在（2026-01-09）
- [ ] 测试用例：
  - [ ] 元组模式匹配（需要验证match表达式中元组模式是否完整工作）

**已知问题**：
- ⚠️ 类型检查错误：元组类型声明时出现"未定义的变量 'i32'"错误，需要修复类型检查器对元组类型的处理（如果还存在）

**参考**：
- 规范：`uya.md` 第 2 章（类型系统）
- 语法：`grammar_formal.md` 类型系统部分

---

## P3：可选功能或实现细节优化

### 10. 泛型系统 ❌

**状态**：❌ **未实现（未来特性）**

**规范要求**（`uya.md` 第 20 章，`grammar_formal.md` 可选特性）：
- 泛型语法：`struct Vec(T)`, `fn id(x: T) T`
- 类型参数列表：`type_param_list = ID { ',' ID }`

**影响**：大型功能，需要完整的类型系统重构

**待办事项**：
- [ ] 语法分析器：
  - [ ] 泛型结构体声明解析
  - [ ] 泛型函数声明解析
  - [ ] 类型参数解析
- [ ] 类型系统扩展：
  - [ ] 类型参数作用域管理
  - [ ] 类型参数约束（如果需要）
- [ ] 单态化（Monomorphization）：
  - [ ] 泛型实例化
  - [ ] 代码生成时的类型特化
- [ ] 类型检查器：
  - [ ] 泛型类型检查
  - [ ] 类型参数推断（如果支持）

**优先级**：低（未来特性，当前规范中标记为可选）

**参考**：
- 规范：`uya.md` 第 20 章（如果存在）
- 语法：`grammar_formal.md` 可选特性部分

---

### 11. 显式宏系统 ❌

**状态**：❌ **未实现（未来特性）**

**规范要求**（`grammar_formal.md` 可选特性）：
- 宏声明：`mc ID '(' [ param_list ] ')' return_tag '{' statements '}'`
- 返回标签：`return_tag = 'expr' | 'stmt' | 'struct' | 'type'`

**影响**：大型功能，需要完整的宏展开系统

**待办事项**：
- [ ] 语法分析器：
  - [ ] 宏声明解析
  - [ ] 宏调用识别
- [ ] 宏展开器（新建）：
  - [ ] 宏展开逻辑
  - [ ] 不同返回标签的处理
- [ ] 代码生成：
  - [ ] 宏展开后的代码生成

**优先级**：低（未来特性，当前规范中标记为可选）

**参考**：
- 语法：`grammar_formal.md` 可选特性部分

---

## 实现细节优化

### 11. 错误码类型一致性检查 ⚠️

**状态**：⚠️ **文档不一致（已修复）**

**问题**：
- ~~`error_design.md` 提到错误码为 `uint16_t`~~（已修复为 `uint32_t`）
- `implementation_status.md` 提到使用 `uint32_t`（根据 uya.md 规范）

**待办事项**：
- [x] 确认错误码类型规范（检查 `uya.md`）- ✅ 已确认为 `uint32_t`
- [x] 如果规范是 `uint32_t`，更新 `error_design.md` - ✅ 已修复
- [ ] 如果规范是 `uint16_t`，更新代码生成以使用 `uint16_t`（不适用，规范是 `uint32_t`）

**优先级**：低（实现细节，不影响功能）

---

### 13. 编译期常量表达式增强 ⚠️

**状态**：⚠️ **基本实现，需要改进**

**待办事项**：
- [ ] 改进类型匹配检查
- [ ] 扩展支持的常量表达式类型
- [ ] 优化常量折叠性能

**参考**：
- `compiler/src/checker/const_eval.c`

---

### 14. 变量遮蔽检查完善 ⚠️

**状态**：⚠️ **基本实现，需要完善**

**当前实现**：
- ✅ 同一作用域内不允许重复定义
- ✅ 不同作用域可以使用同名变量（遮蔽）
- ⚠️ 需要更完善的遮蔽规则验证

**待办事项**：
- [ ] 完善遮蔽规则验证
- [ ] 添加遮蔽相关的错误消息
- [ ] 测试用例完善

---

### 16. 代码优化

**待办事项**：
- [ ] 优化错误码哈希函数的性能（如果必要）
- [ ] 优化错误类型推断的性能（如果必要）
- [ ] 优化常量表达式求值性能
- [ ] 添加错误处理的调试信息（如果必要）

---

## 推荐实现顺序

### 第二阶段：核心功能（P1）

1. **模块系统**
   - 大型功能，可以分阶段实现
   - 建议先实现基础的单文件编译完善，再实现模块系统

### 第三阶段：功能完善（P2）

2. **元组类型完善**
   - 完成剩余的元组字段索引范围检查
   - 完成元组模式匹配支持

### 第四阶段：可选功能（P3）

3. **泛型系统**（未来特性）
4. **显式宏系统**（未来特性）

### 第五阶段：实现细节优化

5. **编译期常量表达式增强**
6. **变量遮蔽检查完善**
7. **代码优化**

---

## 相关文档

- **语言规范**：`uya.md`
- **语法规范**：`grammar_formal.md`
- **实现状态**：`compiler/implementation_status.md`
- **错误处理待办**：`compiler/TODO_error_handling.md`
- **符合性检查**：`compiler/compliance_issues.md`
- **已完成事项**：`compiler/todo_implementation_completed.md`

---

**最后更新**：2026-01-09  
**维护者**：编译器开发团队

