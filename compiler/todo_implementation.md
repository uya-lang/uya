# Uya 编译器实现待办事项

本文档根据 `uya.md` 语法规范和当前实现状态，按优先级组织待实现的功能。

**最后更新**：2025-01-XX  
**基于规范版本**：Uya 0.26

---

## 优先级说明

- **P0（高优先级）**：规范已更新但编译器未实现的破坏性变更，影响代码兼容性
- **P1（中高优先级）**：核心功能缺失，影响语言完整性
- **P2（中优先级）**：有用功能，提升开发体验
- **P3（低优先级）**：可选功能或实现细节优化

---

## P0：破坏性变更（规范已更新，编译器待更新）

### 1. 接口实现语法更新（0.24 版本变更）✅

**状态**：✅ **已完成**

**变更内容**：
- 从 `impl StructName : InterfaceName {}` 简化为 `StructName : InterfaceName {}`
- 移除 `impl` 关键字

**影响**：破坏性变更，现有代码需要迁移

**已完成事项**：
- [x] 修改词法分析器（`lexer/lexer.c`）：`impl` 不再作为关键字
- [x] 修改语法分析器（`parser/parser.c`）：
  - [x] 移除 `parser_match(parser, TOKEN_IMPL)` 的使用
  - [x] 修改 `parser_parse_impl_decl` 函数支持新语法（无需 `impl` 关键字）
  - [x] 修改 `parser_parse_declaration` 函数，添加新解析逻辑识别 `ID : ID {` 形式
  - [x] 添加向前查看（lookahead）来区分结构体方法块和接口实现
- [x] 更新错误消息和文档注释
- [x] 更新测试用例

**相关文件**：
- `compiler/src/lexer/lexer.c`
- `compiler/src/parser/parser.c`
- `compiler/src/parser/ast.h`

**参考**：
- 规范：`uya.md` 第 6 章（接口）
- 语法：`grammar_formal.md` 结构体声明和接口声明部分

---

### 2. 函数指针类型（0.25 版本新增）⚠️

**状态**：⚠️ **规范已更新，编译器代码未实现**

**变更内容**：
- 新增函数指针类型语法：`fn(param_types) return_type`
- 支持 `extern fn name(...) type { ... }` 导出函数给 C
- 支持 `&function_name` 获取函数指针
- 支持函数指针类型别名：`type FuncAlias = fn(...) type;`

**影响**：新功能，不影响现有代码

**待办事项**：
- [ ] 词法分析器：确认是否需要新的 token（当前可能已支持）
- [ ] 语法分析器（`parser/parser.c`）：
  - [ ] 添加函数指针类型解析：`fn '(' [ param_type_list ] ')' type`
  - [ ] 添加函数指针类型别名解析
  - [ ] 添加 `&function_name` 表达式解析（获取函数指针）
- [ ] 类型检查器（`checker/typechecker.c`）：
  - [ ] 添加函数指针类型支持
  - [ ] 验证函数指针类型兼容性
- [ ] IR 生成器（`ir_generator.c`）：
  - [ ] 添加函数指针类型的 IR 表示
  - [ ] 处理 `&function_name` 表达式
- [ ] 代码生成器（`codegen/`）：
  - [ ] 生成函数指针类型定义（C 函数指针）
  - [ ] 实现 `extern fn` 导出函数的代码生成
  - [ ] 实现函数指针调用

**相关文件**：
- `compiler/src/parser/parser.c`
- `compiler/src/checker/typechecker.c`
- `compiler/src/ir/ir.h`
- `compiler/src/ir_generator.c`
- `compiler/src/codegen/`

**参考**：
- 规范：`uya.md` 第 5.2 章（外部 C 函数）
- 语法：`grammar_formal.md` 函数指针类型部分

---

## P1：核心功能缺失

### 3. 模块系统 ❌

**状态**：❌ **未实现**

**规范要求**（`uya.md` 第 1.5 章）：
- 目录级模块系统
- 显式导出 `export` 关键字
- 路径导入 `use` 关键字
- 模块路径：`module_path = ID { '.' ID }`

**影响**：当前只支持单文件编译，无法使用模块系统

**待办事项**：
- [ ] 词法分析器：确认 `export` 和 `use` 关键字支持（可能已支持）
- [ ] 语法分析器：
  - [ ] 实现 `export_decl` 解析
  - [ ] 实现 `import_stmt` 解析（`use module_path [ as ID ] ;`）
- [ ] 模块解析器（新建）：
  - [ ] 目录扫描和模块路径映射
  - [ ] 模块依赖解析
  - [ ] 循环依赖检测
- [ ] 符号表扩展：
  - [ ] 模块级别的符号表
  - [ ] 导出符号管理
  - [ ] 导入符号解析
- [ ] 类型检查器：
  - [ ] 跨模块类型检查
  - [ ] 导出符号可见性检查
- [ ] IR 生成器：
  - [ ] 模块信息的 IR 表示
- [ ] 代码生成器：
  - [ ] 多文件代码生成
  - [ ] 模块前缀处理（如 `std.io.read_file`）

**相关文件**：
- 需要新建：`compiler/src/module/` 目录
- `compiler/src/parser/parser.c`
- `compiler/src/checker/typechecker.c`
- `compiler/src/codegen/codegen_main.c`

**参考**：
- 规范：`uya.md` 第 1.5 章（模块系统）
- 语法：`grammar_formal.md` 第 7 章（模块系统）

**优先级说明**：虽然重要，但可以分阶段实现，先实现单文件编译的完善功能

---

## P2：有用功能，提升开发体验

### 4. 错误类型比较操作 ⚠️

**状态**：⚠️ **部分支持，需要完善**

**规范要求**（`uya.md` 第 875-880 行）：
- 错误类型支持相等性比较：`if err == error.FileNotFound { ... }`
- 错误类型不支持不等性比较（仅支持 `==`）
- catch 块中可以判断错误类型并做不同处理

**当前状态**：
- ✅ 错误类型和错误联合类型已实现
- ❌ 错误类型比较操作未实现

**待办事项**：
- [ ] 类型检查器（`checker/typechecker.c`）：
  - [ ] 识别错误类型比较表达式（`expr == error.ErrorName`）
  - [ ] 验证错误类型比较的类型匹配
  - [ ] 禁止错误类型使用 `!=` 运算符
- [ ] IR 生成器（`ir_generator.c`）：
  - [ ] 生成错误类型比较的 IR 指令
- [ ] 代码生成器（`codegen/codegen_value.c` 或 `codegen_inst.c`）：
  - [ ] 实现错误类型比较的代码生成（比较 `error_id` 字段）
- [ ] 测试用例：
  - [ ] 错误类型比较基本功能
  - [ ] catch 块中的错误类型判断
  - [ ] 预定义错误和运行时错误的混合比较

**相关文件**：
- `compiler/src/checker/typechecker.c`
- `compiler/src/ir_generator.c`
- `compiler/src/codegen/codegen_value.c`
- `compiler/src/codegen/codegen_inst.c`

**参考**：
- 规范：`uya.md` 错误处理章节
- 详细任务：`compiler/TODO_error_handling.md` 第 2 节

---

### 5. 枚举类型增强 ⚠️

**状态**：⚠️ **基础支持，需要验证和完善**

**规范要求**（`uya.md` 第 2 章）：
- 枚举声明：`enum ID [ ':' underlying_type ] '{' enum_variant_list '}'`
- 枚举变体可选显式赋值：`ID [ '=' NUM ]`
- 默认底层类型为 `i32`

**待办事项**：
- [ ] 验证枚举类型的完整实现：
  - [ ] 枚举声明解析
  - [ ] 枚举变体访问（`EnumName.Variant`）
  - [ ] 枚举类型在 match 表达式中的使用
  - [ ] 显式底层类型支持
  - [ ] 显式值赋值支持
- [ ] 类型检查器：
  - [ ] 枚举类型匹配检查
  - [ ] 枚举值范围检查
- [ ] 测试用例：
  - [ ] 基本枚举使用
  - [ ] 枚举在 match 中的模式匹配
  - [ ] 显式底层类型和值

**参考**：
- 规范：`uya.md` 第 2 章（类型系统）
- 语法：`grammar_formal.md` 枚举声明部分

---

### 6. 元组类型增强 ⚠️

**状态**：⚠️ **基础支持，需要验证和完善**

**规范要求**：
- 元组类型：`(T1, T2, ...)`
- 元组字面量：`(expr1, expr2, ...)`
- 元组字段访问：`tuple.0`, `tuple.1`, ...
- 元组模式匹配：`(pattern1, pattern2, ...)`

**待办事项**：
- [ ] 验证元组类型的完整实现：
  - [ ] 元组类型声明和使用
  - [ ] 元组字面量
  - [ ] 元组字段访问（`.0`, `.1`, ...）
  - [ ] 元组在 match 表达式中的模式匹配
- [ ] 类型检查器：
  - [ ] 元组类型匹配
  - [ ] 元组字段索引范围检查
- [ ] 测试用例：
  - [ ] 基本元组使用
  - [ ] 元组字段访问
  - [ ] 元组模式匹配

**参考**：
- 规范：`uya.md` 第 2 章（类型系统）
- 语法：`grammar_formal.md` 类型系统部分

---

### 7. match 表达式增强 ⚠️

**状态**：⚠️ **基础支持，需要验证和完善**

**规范要求**（`uya.md` 第 8 章）：
- match 表达式：`match expr '{' pattern_list '}'`
- 支持的模式：字面量、标识符、结构体模式、元组模式、枚举模式、错误模式
- `else` 分支必须放在最后

**待办事项**：
- [ ] 验证 match 表达式的完整实现：
  - [ ] 所有模式类型的支持
  - [ ] 模式匹配的完整性检查（是否所有情况都被覆盖）
  - [ ] `else` 分支处理
- [ ] 类型检查器：
  - [ ] 模式类型匹配检查
  - [ ] 模式完整性检查
- [ ] 测试用例：
  - [ ] 各种模式类型的测试
  - [ ] 模式匹配完整性检查

**参考**：
- 规范：`uya.md` 第 8 章（控制流）
- 语法：`grammar_formal.md` match 表达式部分

---

## P3：可选功能或实现细节优化

### 8. 预定义错误声明（可选功能）

**状态**：❌ **未实现（可选）**

**规范要求**（`uya.md` 第 417-423 行）：
- 支持 `error ErrorName;` 在顶层声明预定义错误
- 预定义错误类型是编译期常量
- 预定义错误类型名称必须唯一（全局命名空间）

**当前状态**：
- ❌ 不支持预定义错误声明语法
- ✅ 支持运行时错误（`error.ErrorName` 直接使用）

**待办事项**：
- [ ] 语法分析器：
  - [ ] 添加 `AST_ERROR_DECL` 节点类型（`ast.h`）
  - [ ] 实现 `error ErrorName;` 语法解析（`parser.c`）
- [ ] 符号表：
  - [ ] 存储预定义错误类型
  - [ ] 验证预定义错误名称唯一性（全局命名空间）
- [ ] 代码生成：
  - [ ] 确保预定义错误和运行时错误使用相同的错误码生成机制

**优先级**：低（可选功能，运行时错误已足够）

**参考**：
- 详细任务：`compiler/TODO_error_handling.md` 第 1 节

---

### 9. 泛型系统 ❌

**状态**：❌ **未实现（未来特性）**

**规范要求**（`uya.md` 第 20 章，`grammar_formal.md` 可选特性）：
- 泛型语法：`struct Vec(T)`, `fn id(x: T) T`
- 类型参数列表：`type_param_list = ID { ',' ID }`

**影响**：大型功能，需要完整的类型系统重构

**待办事项**：
- [ ] 语法分析器：
  - [ ] 泛型结构体声明解析
  - [ ] 泛型函数声明解析
  - [ ] 类型参数解析
- [ ] 类型系统扩展：
  - [ ] 类型参数作用域管理
  - [ ] 类型参数约束（如果需要）
- [ ] 单态化（Monomorphization）：
  - [ ] 泛型实例化
  - [ ] 代码生成时的类型特化
- [ ] 类型检查器：
  - [ ] 泛型类型检查
  - [ ] 类型参数推断（如果支持）

**优先级**：低（未来特性，当前规范中标记为可选）

**参考**：
- 规范：`uya.md` 第 20 章（如果存在）
- 语法：`grammar_formal.md` 可选特性部分

---

### 10. 显式宏系统 ❌

**状态**：❌ **未实现（未来特性）**

**规范要求**（`grammar_formal.md` 可选特性）：
- 宏声明：`mc ID '(' [ param_list ] ')' return_tag '{' statements '}'`
- 返回标签：`return_tag = 'expr' | 'stmt' | 'struct' | 'type'`

**影响**：大型功能，需要完整的宏展开系统

**待办事项**：
- [ ] 语法分析器：
  - [ ] 宏声明解析
  - [ ] 宏调用识别
- [ ] 宏展开器（新建）：
  - [ ] 宏展开逻辑
  - [ ] 不同返回标签的处理
- [ ] 代码生成：
  - [ ] 宏展开后的代码生成

**优先级**：低（未来特性，当前规范中标记为可选）

**参考**：
- 语法：`grammar_formal.md` 可选特性部分

---

## 实现细节优化

### 11. 错误码类型一致性检查

**状态**：⚠️ **文档不一致**

**问题**：
- `error_design.md` 提到错误码为 `uint16_t`
- `implementation_status.md` 提到使用 `uint32_t`（根据 uya.md 规范）

**待办事项**：
- [ ] 确认错误码类型规范（检查 `uya.md`）
- [ ] 如果规范是 `uint32_t`，更新 `error_design.md`
- [ ] 如果规范是 `uint16_t`，更新代码生成以使用 `uint16_t`

**优先级**：低（实现细节，不影响功能）

---

### 12. 编译期常量表达式增强

**状态**：⚠️ **基本实现，需要改进**

**待办事项**：
- [ ] 改进类型匹配检查
- [ ] 扩展支持的常量表达式类型
- [ ] 优化常量折叠性能

**参考**：
- `compiler/src/checker/const_eval.c`

---

### 13. 变量遮蔽检查完善

**状态**：⚠️ **基本实现，需要完善**

**当前实现**：
- ✅ 同一作用域内不允许重复定义
- ✅ 不同作用域可以使用同名变量（遮蔽）
- ⚠️ 需要更完善的遮蔽规则验证

**待办事项**：
- [ ] 完善遮蔽规则验证
- [ ] 添加遮蔽相关的错误消息
- [ ] 测试用例完善

---

## 测试和文档

### 14. 测试覆盖完善

**待办事项**：
- [ ] 错误类型比较的测试用例
- [ ] 预定义错误的测试用例（如果实现）
- [ ] catch 块中错误类型判断的测试用例
- [ ] 枚举类型的完整测试用例
- [ ] 元组类型的完整测试用例
- [ ] match 表达式的完整测试用例
- [ ] 跨函数调用的错误传播测试
- [ ] 错误码冲突检测测试

---

### 15. 代码优化

**待办事项**：
- [ ] 优化错误码哈希函数的性能（如果必要）
- [ ] 优化错误类型推断的性能（如果必要）
- [ ] 优化常量表达式求值性能
- [ ] 添加错误处理的调试信息（如果必要）

---

## 实现状态总结

### ✅ 已完全实现（核心安全特性）

1. ✅ 类型检查器核心功能
2. ✅ 数组边界检查
3. ✅ 整数溢出检查
4. ✅ 除零检查
5. ✅ 未初始化内存检查
6. ✅ 空指针解引用检查
7. ✅ 路径敏感分析（约束系统）
8. ✅ 切片语法支持
9. ✅ For 循环语法
10. ✅ 错误处理基础（错误联合类型 `!T`、try/catch、errdefer）
11. ✅ defer 语句

### ⚠️ 部分实现/需要更新

12. ✅ 接口实现语法（规范已更新为新语法，编译器代码已更新）
13. ⚠️ 错误类型比较（未实现）
14. ⚠️ 枚举类型（需要验证和完善）
15. ⚠️ 元组类型（需要验证和完善）
16. ⚠️ match 表达式（需要验证和完善）

### ❌ 未实现

17. ❌ 函数指针类型（0.25 版本新增，规范已更新）
18. ❌ 模块系统
19. ❌ 泛型（可选特性）
20. ❌ 显式宏系统（可选特性）
21. ❌ 预定义错误声明（可选功能）

---

## 推荐实现顺序

### 第一阶段：破坏性变更（P0）

1. **接口实现语法更新**（0.24 版本）
   - 影响现有代码，需要优先处理
   - 相对简单，主要是语法解析修改

2. **函数指针类型**（0.25 版本）
   - 新功能，不影响现有代码
   - 需要完整的类型系统支持

### 第二阶段：核心功能（P1）

3. **模块系统**
   - 大型功能，可以分阶段实现
   - 建议先实现基础的单文件编译完善，再实现模块系统

### 第三阶段：功能完善（P2）

4. **错误类型比较**
5. **枚举类型增强**
6. **元组类型增强**
7. **match 表达式增强**

### 第四阶段：可选功能（P3）

8. **预定义错误声明**（如果用户需要）
9. **泛型系统**（未来特性）
10. **显式宏系统**（未来特性）

---

## 相关文档

- **语言规范**：`uya.md`
- **语法规范**：`grammar_formal.md`
- **实现状态**：`compiler/implementation_status.md`
- **错误处理待办**：`compiler/TODO_error_handling.md`
- **符合性检查**：`compiler/compliance_issues.md`

---

**最后更新**：2025-01-XX  
**维护者**：编译器开发团队

