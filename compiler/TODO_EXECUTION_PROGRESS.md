# 待办事项执行进度

**最后更新**：2026-01-09

---

## ✅ 已完成的任务

### 1. 元组字段索引范围检查 ✅

**状态**：✅ **已完成**

**实现内容**：
- ✅ 扩展 `Symbol` 结构，添加 `tuple_element_count` 字段（类似于 `array_size`）
- ✅ 添加 `get_tuple_element_count_from_ast` 函数，从 AST 类型节点提取元组元素数量
- ✅ 在 `symbol_new` 中初始化 `tuple_element_count` 为 -1（默认非元组）
- ✅ 在 `typecheck_var_decl` 中提取和存储元组信息（当变量类型是 `AST_TYPE_TUPLE` 时）
- ✅ 在元组字段访问检查（`AST_MEMBER_ACCESS` case）中实现索引范围验证

**实现细节**：
- 当检测到元组字段访问（如 `tuple.0`）时：
  1. 检查对象是否存在并类型检查通过
  2. 将字段名（数字字符串）转换为整数索引
  3. 从符号表获取对象的元组元素数量信息
  4. 如果元素数量信息可用，检查索引是否在有效范围内（0 到 element_count-1）
  5. 如果索引越界，报告编译错误

**修改的文件**：
- `compiler/src/checker/typechecker.h` - 扩展 Symbol 结构
- `compiler/src/checker/typechecker.c` - 实现索引范围检查逻辑

**错误消息示例**：
```
元组字段索引越界：索引 5 超出元组大小 3 (字段 'pair.5' 在 test.uya:10:15)
```

**限制说明**：
- 当前实现仅支持直接变量访问（`variable.0`），对于复杂表达式（如函数返回值）可能无法获取类型信息
- 如果无法获取元组元素数量信息，访问将被允许（向后兼容）

---

## 📋 待执行的任务

### 2. 元组类型声明类型检查错误修复 ⚠️

**状态**：⚠️ **待验证**

**任务**：
- 验证错误是否仍然存在
- 如果存在，修复类型检查器对元组类型的处理

---

### 3. 元组模式匹配完善 ⚠️

**状态**：⚠️ **待验证**

**任务**：
- 验证 match 表达式中元组模式匹配是否完整工作
- 如果需要，完善元组模式的 IR 生成和代码生成

---

### 4. 变量遮蔽检查完善 ⚠️

**状态**：⚠️ **待执行**

**任务**：
- 完善遮蔽规则验证
- 添加遮蔽相关的错误消息
- 测试用例完善

---

### 5. 编译期常量表达式增强 ⚠️

**状态**：⚠️ **待执行**

**任务**：
- 改进类型匹配检查
- 扩展支持的常量表达式类型
- 优化常量折叠性能

---

### 6. 模块系统 ❌

**状态**：❌ **未开始**

**优先级**：P1（核心功能）
**复杂度**：高（大型功能）
**预计工作量**：2-4 周

---

## 📝 下一步建议

1. **测试元组字段索引范围检查**：
   - 创建测试用例验证功能正确性
   - 测试正常访问（有效索引）
   - 测试越界访问（应报告错误）

2. **验证元组类型声明错误**：
   - 检查是否还存在"未定义的变量 'i32'"错误
   - 如果存在，修复类型检查器

3. **验证元组模式匹配**：
   - 测试 match 表达式中元组模式是否正常工作
   - 如果需要，完善实现

4. **继续执行其他任务**：
   - 变量遮蔽检查完善（相对简单）
   - 编译期常量表达式增强

---

**相关文档**：
- [待办事项](todo_implementation_pending.md)
- [执行计划](TODO_EXECUTION_PLAN.md)

