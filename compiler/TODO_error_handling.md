# 错误处理待办事项

基于 `implementation_status.md` 和 `uya.md` 语法规范生成的待办事项清单。

## 已实现功能 ✅

根据 `implementation_status.md`，以下功能已经完成：

1. ✅ **IR_ERROR_VALUE 指令类型**：错误值识别和错误码生成
2. ✅ **标记联合类型 `!T`**：错误联合类型的代码生成
3. ✅ **errdefer 支持**：错误返回时的清理逻辑
4. ✅ **try/catch 语法**：错误传播和捕获

## 待实现功能

### 1. 预定义错误声明（可选功能）

**语法规范**（`uya.md` 第417-423行）：
- 支持 `error ErrorName;` 在顶层声明预定义错误
- 预定义错误类型是编译期常量
- 预定义错误类型名称必须唯一（全局命名空间）

**当前状态**：
- ❌ 不支持预定义错误声明语法
- ✅ 支持运行时错误（`error.ErrorName` 直接使用）

**待办事项**：
- [ ] 在解析器中添加 `AST_ERROR_DECL` 节点类型
- [ ] 实现 `error ErrorName;` 语法的解析（`parser.c`）
- [ ] 在符号表中存储预定义错误类型
- [ ] 验证预定义错误名称唯一性（全局命名空间）
- [ ] 确保预定义错误和运行时错误使用相同的错误码生成机制

**优先级**：低（可选功能，运行时错误已足够）

---

### 2. 错误类型比较操作

**语法规范**（`uya.md` 第875-880行）：
- 错误类型支持相等性比较：`if err == error.FileNotFound { ... }`
- 错误类型不支持不等性比较（仅支持 `==`）
- catch 块中可以判断错误类型并做不同处理
- 支持预定义错误和运行时错误的混合比较

**当前状态**：
- ❌ 未找到错误类型比较的实现代码
- ❌ 需要在 catch 块中支持错误类型比较

**待办事项**：
- [ ] 实现错误类型比较操作（`err == error.ErrorName`）
- [ ] 在类型检查器中添加错误类型比较的类型检查
- [ ] 在代码生成中实现错误类型比较（比较 `error_id` 字段）
- [ ] 确保错误类型只能使用 `==`，不能使用 `!=`
- [ ] 在 catch 块中支持错误类型比较和分支处理

**优先级**：中（有用的功能，catch 块中需要错误类型判断）

---

### 3. 错误类型推断增强

**语法规范**（`uya.md` 第435-438行）：
- 函数返回 `!T` 类型时，所有可能的错误类型自动推断
- 编译器自动推断函数可能返回的所有错误
- 无需显式声明函数可能返回的错误集合

**当前状态**：
- ✅ 错误码通过哈希函数自动生成
- ❓ 错误类型推断的完整性和准确性需要验证

**待办事项**：
- [ ] 验证错误类型推断是否正确收集所有错误
- [ ] 确保跨函数调用的错误类型推断正确
- [ ] 添加错误类型推断的测试用例

**优先级**：低（当前实现可能已足够，需要验证）

---

### 4. 错误类型不能直接打印

**语法规范**（`uya.md` 第879行）：
- 错误类型不能直接打印，需要通过模式匹配处理

**当前状态**：
- ❓ 需要验证是否阻止了错误类型的直接打印

**待办事项**：
- [ ] 在类型检查器中禁止错误类型的直接打印（如 `printf`）
- [ ] 确保错误类型只能通过 `==` 比较或模式匹配使用

**优先级**：低（可能已在类型检查中处理）

---

### 5. 错误码类型一致性检查

**规范说明**：
- `error_design.md` 提到错误码为 `uint16_t`
- `implementation_status.md` 提到使用 `uint32_t`（根据 uya.md 规范）

**待办事项**：
- [ ] 确认错误码类型规范（`uint16_t` 还是 `uint32_t`）
- [ ] 如果规范是 `uint32_t`，更新 `error_design.md`
- [ ] 如果规范是 `uint16_t`，更新代码生成以使用 `uint16_t`

**优先级**：低（实现细节，不影响功能）

---

## 测试和优化

### 测试覆盖

- [ ] 添加错误类型比较的测试用例
- [ ] 添加预定义错误的测试用例（如果实现）
- [ ] 添加 catch 块中错误类型判断的测试用例
- [ ] 测试跨函数调用的错误传播
- [ ] 测试错误码冲突检测

### 代码优化

- [ ] 优化错误码哈希函数的性能（如果必要）
- [ ] 优化错误类型推断的性能（如果必要）
- [ ] 添加错误处理的调试信息（如果必要）

---

## 相关文档

- **实现状态**：`compiler/implementation_status.md`
- **架构设计**：`compiler/error_design.md`
- **语法规范**：`uya.md` 第2章（类型系统）和第5章（函数）
- **BNF 语法**：`grammar_formal.md` 第9章（错误处理）

---

## 优先级说明

- **高优先级**：核心功能缺失，影响语言完整性
- **中优先级**：有用功能，提升开发体验
- **低优先级**：可选功能或实现细节优化

**当前建议**：
1. 首先实现错误类型比较（中优先级）
2. 然后考虑预定义错误声明（低优先级，可选）
3. 最后进行测试覆盖和优化

