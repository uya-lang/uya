// 测试 !T 类型的结构体布局
// 根据 uya.md 规范，!T 在 C 中应该表示为：
// struct error_union_T {
//     uint32_t error_id; // 0 = 成功（使用 value），非0 = 错误（使用 error_id）
//     T value;           // 成功时的值类型
// };

extern printf(fmt: *byte, ...) i32;

// 测试 1: !i32 类型的函数返回
fn test_i32_success() !i32 {
    return 42;  // 正常返回，error_id 应该为 0，value 应该为 42
}

fn test_i32_error() !i32 {
    return error.TestError;  // 错误返回，error_id 应该为非0错误码
}

// 测试 2: !void 类型的函数返回
fn test_void_success() !void {
    return;  // 正常返回，error_id 应该为 0
}

fn test_void_error() !void {
    return error.TestError;  // 错误返回，error_id 应该为非0错误码
}

// 测试 3: 多个不同的错误类型
fn test_multiple_errors() !i32 {
    return error.FileNotFound;  // 测试不同的错误码
}

fn main() i32 {
    // 测试正常返回值
    const result1: i32 = test_i32_success() catch |err| {
        printf("Unexpected error: %d\n", 1);
        return 1;
    };
    if result1 != 42 {
        printf("Expected 42, got %d\n", result1);
        return 1;
    }
    
    // 测试错误返回值
    const result2: i32 = test_i32_error() catch |err| {
        if err == error.TestError {
            printf("Caught TestError as expected\n");
        } else {
            printf("Unexpected error type\n");
            return 1;
        }
        return 0;  // 返回默认值
    };
    
    // 测试 !void 正常返回
    test_void_success() catch |err| {
        printf("Unexpected error in void function\n");
        return 1;
    };
    
    // 测试 !void 错误返回
    test_void_error() catch |err| {
        if err == error.TestError {
            printf("Caught TestError in void function\n");
        } else {
            printf("Unexpected error type in void function\n");
            return 1;
        }
    };
    
    // 测试多个错误类型
    const result3: i32 = test_multiple_errors() catch |err| {
        if err == error.FileNotFound {
            printf("Caught FileNotFound as expected\n");
        } else {
            printf("Unexpected error type\n");
            return 1;
        }
        return 0;
    };
    
    printf("All layout tests passed\n");
    return 0;
}

