// 测试跨函数调用的错误传播
// 验证错误可以在函数调用链中正确传播

error FileNotFound;
error ParseError;
error ValidationError;

fn read_file() !i32 {
    return error.FileNotFound;
}

fn parse_content(content: i32) !i32 {
    if content < 0 {
        return error.ParseError;
    }
    return content * 2;
}

fn validate_data(data: i32) !i32 {
    if data > 1000 {
        return error.ValidationError;
    }
    return data;
}

fn process_data() !i32 {
    // 函数调用链：read_file -> parse_content -> validate_data
    const content: i32 = try read_file();
    const parsed: i32 = try parse_content(content);
    const validated: i32 = try validate_data(parsed);
    return validated;
}

fn test_error_propagation_single() i32 {
    // 测试错误从read_file传播
    const result: i32 = process_data() catch |err| {
        if err == error.FileNotFound {
            return 404;
        }
        return 0;
    };
    
    if result != 404 {
        return 1;
    }
    
    return 0;
}

fn step1() !i32 {
    return error.FileNotFound;
}

fn step2(data: i32) !i32 {
    const value: i32 = try step1();
    return value + data;
}

fn step3(data: i32) !i32 {
    const value: i32 = try step2(data);
    return value * 2;
}
    
fn test_error_propagation_chain() !i32 {

    const result: i32 = step3(10) catch |err| {
        if err == error.FileNotFound {
            return 404;
        }
        return 0;
    };
    
    if result != 404 {
        return 1;
    }
    
    return 0;
}
fn func1() !i32 {
    return error.FileNotFound;
}

fn func2() !i32 {
    const val: i32 = try func1();
    if val < 0 {
        return error.ParseError;
    }
    return val;
}

fn func3() !i32 {
    const val: i32 = try func2();
    return val;
}
    

fn test_error_propagation_different_errors() i32 {
 
    const result: i32 = func3() catch |err| {
        if err == error.FileNotFound {
            return 404;
        } else if err == error.ParseError {
            return 400;
        }
        return 0;
    };
    
    if result != 404 {
        return 1;
    }
    
    return 0;
}

fn main() i32 {
    if test_error_propagation_single() != 0 {
        return 1;
    }
    const chain_result: i32 = test_error_propagation_chain() catch |err| {
        return 2;
    };
    if chain_result != 0 {
        return 2;
    }
    if test_error_propagation_different_errors() != 0 {
        return 3;
    }
    return 0;
}

