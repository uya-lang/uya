# Uya v0.1.2 版本说明

**发布日期**：2026-01-31

本版本在 v0.1.1 基础上新增 **位运算符** 支持（`&` `|` `^` `~` `<<` `>>`），完成规范、C 编译器、自举编译器的同步实现，并通过自举对比验证。同时明确测试验证规则：测试用例须同时通过 `--c99` 与 `--uya --c99`。

---

## 核心变更

### 位运算符支持

- **按位与** `&`：两操作数须为 `i32` 或 `usize`，类型一致，结果类型与操作数相同
- **按位或** `|`：同上
- **按位异或** `^`：同上
- **按位取反** `~`（一元）：操作数须为 `i32` 或 `usize`，结果类型与操作数相同
- **左移** `<<`：左操作数须为 `i32` 或 `usize`，右操作数须为 `i32`，结果类型与左操作数相同
- **右移** `>>`：同上（算术右移，有符号数保留符号位）

### 表达式优先级调整

在原有表达式层级中插入位运算与位移层级，优先级（从高到低）为：

1. 一元 `!` `-` `~` `&` `*`
2. `as`
3. `*` `/` `%`
4. `+` `-`
5. **`<<` `>>`**
6. `<` `>` `<=` `>=`
7. `==` `!=`
8. **`&`**
9. **`^`**
10. **`|`**
11. `&&`
12. `||`
13. `=`

### for 循环与 `|` 的歧义处理

- **问题**：引入按位或 `|` 后，`for arr | i | { ... }` 中的集合表达式若用完整表达式解析，会把 `arr | i` 解析成按位或，导致后续 `{` 被误报为“意外 token”。
- **处理**：for 语句的集合表达式改为只解析到 **xor_expr**（不包含顶层 `|`），使 `|` 仅作为 for 的分隔符，`for arr | i | { ... }` 与按位或表达式均可正确解析。

### 测试与规则

- **测试用例**：新增 `tests/programs/test_bitwise.uya`，覆盖 `&` `|` `^` `~` `<<` `>>` 及优先级。
- **验证规则**（已写入 `.cursorrules`）：每个测试用例须同时通过 `--c99`（C 版编译器）和 `--uya --c99`（自举版编译器），二者都通过才算测试通过。

---

## 实现范围

| 模块 | C 编译器 | 自举编译器 |
|------|----------|------------|
| 规范 | UYA_MINI_SPEC 运算符、BNF、优先级与语义 | — |
| 词法 | TOKEN_CARET / TILDE / LSHIFT / RSHIFT，`^` `~` `<<` `>>` | ✓ |
| 语法 | shift_expr, bitand_expr, xor_expr, bitor_expr，一元 `~` | ✓ |
| 类型检查 | 位运算操作数 i32/usize，移位右操作数 i32 | ✓ |
| C99 后端 | `&` `|` `^` `<<` `>>` 与一元 `~` 的 C 输出 | ✓ |

---

## 与 v0.1.1 的差异

| 项目 | v0.1.1 | v0.1.2 |
|------|--------|--------|
| 运算符 | 算术、比较、逻辑、一元 `!` `-` `&` `*` | 同上 + **位运算** `&` `|` `^` `~` `<<` `>>` |
| 表达式层级 | or → and → eq → rel → add → mul → … | or → **bitor** → **xor** → **bitand** → and → eq → rel → **shift** → add → … |
| for 集合表达式 | 使用完整 expression | 使用 **xor_expr**（避免 `|` 与 for 分隔符冲突） |
| 测试规则 | — | **须同时通过 --c99 与 --uya --c99** |

---

## 验证

### 位运算测试

```bash
# C 版编译器
./tests/run_programs.sh --c99 test_bitwise.uya

# 自举编译器
./tests/run_programs.sh --uya --c99 test_bitwise.uya
```

### 自举对比

```bash
cd compiler-mini/uya-src
./compile.sh --c99 -b    # C 输出与自举输出逐字节一致 ✓
```

### 全量测试

新增或修改的测试用例需保证 `--c99` 与 `--uya --c99` 均通过（见 `.cursorrules` 验证流程）。

---

## 附录：版本与仓库

- **版本**：v0.1.2
- **基于**：v0.1.1
- **仓库**：<https://github.com/uya-lang/uya>
- **许可**：MIT（见 [LICENSE](LICENSE)）
